<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart Map | An Interactive Love Letter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Dancing+Script:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cream: #FDF8F3;
      --sage: #7D8B6F;
      --deep-sage: #5C6B4F;
      --blush: #E8DDD4;
      --moss: #4A5D3E;
      --rose-gold: #B76E79;
      --dusty-rose: #C9A9A6;
      --soft-pink: #E8B4B8;
      --pale-pink: #F5C6D6;
      --deep-pink: #9E4A5A;
    }
    
    body {
      background: var(--cream);
      font-family: 'Inter', sans-serif;
      color: #2C3E2F;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }
    
    .romantic-title {
      font-family: 'Cormorant Garamond', serif;
    }
    
    .script-font {
      font-family: 'Dancing Script', cursive;
    }
    
    .elegant-font {
      font-family: 'Playfair Display', serif;
    }
    
    /* NO button styles - NOT flying, not red */
    .no-btn {
      padding: 12px 24px !important;
      border-radius: 50px !important;
      font-size: 16px !important;
      background: var(--cream) !important;
      color: var(--sage) !important;
      border: 2px solid var(--sage) !important;
      box-shadow: 0 4px 12px rgba(92, 107, 79, 0.15) !important;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      max-width: 180px;
      text-align: center;
      line-height: 1.4;
      position: absolute !important;
      z-index: 100;
    }
    
    .no-btn:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 6px 20px rgba(92, 107, 79, 0.25) !important;
      background: var(--blush) !important;
      border-color: var(--deep-sage) !important;
    }
    
    .no-btn i {
      font-size: 14px;
      margin-right: 6px;
    }
    
    /* Floating animations */
    @keyframes floatUp {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      90% {
        opacity: 0.7;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }
    
    @keyframes floatUpPink {
      0% {
        transform: translateY(100vh) rotate(180deg) translateX(-30px);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.6;
      }
      100% {
        transform: translateY(-100px) rotate(540deg) translateX(30px);
        opacity: 0;
      }
    }
    
    .floating-element {
      position: fixed;
      pointer-events: none;
      z-index: 1;
      animation: floatUp linear forwards;
    }
    
    .floating-element.pink {
      animation: floatUpPink linear forwards;
    }
    
    /* Heart animations */
    @keyframes gentlePulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.9;
      }
      50% {
        transform: scale(1.08);
        opacity: 1;
      }
    }
    
    @keyframes heartbeat {
      0% {
        transform: scale(1);
      }
      14% {
        transform: scale(1.1);
      }
      28% {
        transform: scale(1);
      }
      42% {
        transform: scale(1.1);
      }
      70% {
        transform: scale(1);
      }
    }
    
    .gentle-pulse {
      animation: gentlePulse 4s ease-in-out infinite;
    }
    
    .heartbeat {
      animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    /* Page transitions */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        visibility: hidden;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }
    
    .fade-out {
      animation: fadeOut 0.8s ease-out forwards;
    }
    
    /* Progress indicator */
    .progress-track {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(232, 221, 212, 0.3);
      z-index: 1000;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--sage), var(--rose-gold));
      width: 0%;
      transition: width 0.6s ease;
      border-radius: 0 3px 3px 0;
    }
    
    /* Navigation */
    .nav-dots {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .nav-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(125, 139, 111, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .nav-dot:hover {
      background: var(--rose-gold);
      transform: scale(1.4);
    }
    
    .nav-dot.active {
      background: var(--rose-gold);
      transform: scale(1.4);
      box-shadow: 0 0 0 2px rgba(183, 110, 121, 0.1);
    }
    
    .nav-dot.completed:after {
      content: 'âœ“';
      position: absolute;
      top: -2px;
      left: 1px;
      font-size: 8px;
      color: white;
    }
    
    /* Cards and containers */
    .elegant-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 
        0 10px 40px rgba(92, 107, 79, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(232, 221, 212, 0.6);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 
        0 15px 35px rgba(183, 110, 121, 0.08),
        0 5px 15px rgba(0, 0, 0, 0.03);
    }
    
    /* Buttons */
    .primary-btn {
      background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 50px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .primary-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(183, 110, 121, 0.25);
      background: linear-gradient(135deg, var(--deep-pink), var(--rose-gold));
    }
    
    .primary-btn:active {
      transform: translateY(-1px);
    }
    
    .secondary-btn {
      background: transparent;
      color: var(--rose-gold);
      border: 2px solid var(--rose-gold);
      padding: 12px 28px;
      border-radius: 50px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .secondary-btn:hover {
      background: rgba(183, 110, 121, 0.08);
      transform: translateY(-2px);
    }
    
    /* Form elements */
    .elegant-input {
      background: transparent;
      border: none;
      border-bottom: 2px solid rgba(183, 110, 121, 0.2);
      padding: 12px 0;
      font-size: 20px;
      font-family: 'Dancing Script', cursive;
      color: var(--deep-sage);
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .elegant-input:focus {
      outline: none;
      border-bottom-color: var(--rose-gold);
      background: rgba(183, 110, 121, 0.03);
      padding-left: 12px;
      padding-right: 12px;
    }
    
    .elegant-input::placeholder {
      color: rgba(183, 110, 121, 0.4);
      font-style: italic;
    }
    
    /* Typography */
    h1, h2, h3, h4 {
      color: #2C3E2F;
      font-weight: 500;
      line-height: 1.2;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, var(--sage), var(--rose-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtle-text {
      color: #5A6B5C;
      line-height: 1.7;
    }
    
    /* Completion states */
    .completion-checkmark {
      width: 24px;
      height: 24px;
      background: var(--sage);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    
    /* View-only mode */
    .view-only .editable-content,
    .view-only input,
    .view-only textarea {
      pointer-events: none;
      background: transparent;
      border: none;
      user-select: text;
      -webkit-user-select: text;
    }
    
    .view-only .elegant-input {
      border-bottom: 1px solid rgba(183, 110, 121, 0.1);
    }
    
    .view-only .primary-btn,
    .view-only .secondary-btn {
      cursor: default;
    }
    
    .view-only .primary-btn:hover,
    .view-only .secondary-btn:hover {
      transform: none;
      box-shadow: none;
    }
    
    .creator-mode .primary-btn,
    .creator-mode .secondary-btn {
      pointer-events: auto;
    }
    
    /* Hide creator-only elements in partner view */
    .view-only .creator-only,
    .view-only .editable-field,
    .view-only [class*="STEP"],
    .view-only .completion-checkmark {
      display: none !important;
    }
    
    /* Show partner-only elements */
    .view-only .partner-only {
      display: block !important;
    }
    
    .creator-only {
      display: block;
    }
    
    .partner-only {
      display: none;
    }
    
    /* Adjust sections for partner view */
    .view-only .section > div {
      width: 100%;
      max-width: 800px !important;
    }
    
    /* Preview mode */
    .preview-mode .creator-only {
      display: none !important;
    }
    
    .preview-mode .partner-only {
      display: block !important;
    }
    
    .preview-mode .editable-field,
    .preview-mode [class*="STEP"],
    .preview-mode .completion-checkmark {
      display: none !important;
    }
    
    .preview-mode .section > div {
      width: 100%;
      max-width: 800px !important;
    }
    
    /* Section visibility control */
    .section {
      display: none;
      min-height: 100vh;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .section.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Valentine screen specific styles */
    #valentine-question .elegant-card {
      position: relative;
      overflow: hidden;
    }
    
    #valentine-hearts-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    
    /* Celebration animation */
    @keyframes celebrate {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(1.5);
        opacity: 0;
      }
    }
    
    /* Show/hide animation for secret message */
    .show {
      display: block !important;
    }
    
    /* Share link success animation */
    @keyframes successPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(125, 139, 111, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(125, 139, 111, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(125, 139, 111, 0);
      }
    }
    
    .success-pulse {
      animation: successPulse 1.5s ease-out;
    }
    
    /* Memory textarea styles */
    .memory-description {
      display: block !important;
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid rgba(183, 110, 121, 0.3);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: var(--deep-sage);
      background: rgba(255, 255, 255, 0.9);
      resize: vertical;
      transition: all 0.3s ease;
      margin-top: 1rem !important;
    }
    
    .memory-description:focus {
      outline: none;
      border-color: var(--rose-gold);
      box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
    }
    
    /* Preview container */
    .preview-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--cream);
      z-index: 2000;
      overflow-y: auto;
      display: none;
    }
    
    .preview-container.active {
      display: block;
    }
    
    .preview-header {
      position: sticky;
      top: 0;
      background: var(--cream);
      padding: 1rem;
      border-bottom: 1px solid rgba(183, 110, 121, 0.1);
      z-index: 2001;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .nav-dots {
        right: 16px;
      }
      
      .elegant-card {
        padding: 1.5rem;
        margin: 0 1rem;
      }
      
      h1 {
        font-size: 2.5rem;
      }
      
      .primary-btn, .secondary-btn {
        padding: 12px 24px;
        font-size: 15px;
      }
      
      .section.active {
        padding: 10px;
      }
      
      .no-btn {
        padding: 10px 20px !important;
        font-size: 14px !important;
        max-width: 160px;
      }
    }
    
    /* Loading states */
    .loading-dots {
      display: inline-block;
    }
    
    .loading-dots span {
      animation: blink 1.4s infinite both;
      display: inline-block;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    
    /* Remove smooth scrolling */
    html {
      scroll-behavior: auto;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(232, 221, 212, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(183, 110, 121, 0.4);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(183, 110, 121, 0.6);
    }
    
    /* Valentine screen fix */
    #valentine-question.section.active {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px !important;
      min-height: 100vh !important;
      width: 100% !important;
    }
  </style>
</head>
<body>
  <!-- NO Button Container (Will be created dynamically) -->
  <div id="no-button-container"></div>
  
  <!-- Floating Elements -->
  <div id="floating-container"></div>
  
  <!-- Progress Indicator -->
  <div class="progress-track">
    <div id="progress-fill" class="progress-fill"></div>
  </div>
  
  <!-- Navigation Dots -->
  <div class="nav-dots">
    <div class="nav-dot" data-section="valentine-question"></div>
    <div class="nav-dot active completed" data-section="welcome"></div>
    <div class="nav-dot" data-section="greeting"></div>
    <div class="nav-dot" data-section="letter"></div>
    <div class="nav-dot" data-section="memories"></div>
    <div class="nav-dot" data-section="final"></div>
  </div>
  
  <!-- Preview Container -->
  <div id="preview-container" class="preview-container">
    <div class="preview-header">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
          <i class="fas fa-eye text-white"></i>
        </div>
        <h3 class="text-xl elegant-font">Preview Mode</h3>
      </div>
      <button id="close-preview" class="secondary-btn">
        <i class="fas fa-times mr-2"></i>Close Preview
      </button>
    </div>
    <div id="preview-content" class="p-4"></div>
  </div>
  
  <!-- Main Content -->
  <main>
    <!-- Valentine Question Screen (Shown to partner only) -->
    <section id="valentine-question" class="section">
      <div class="text-center max-w-3xl w-full fade-in">
        <div class="elegant-card mx-auto">
          <!-- Animated Hearts Background -->
          <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div id="valentine-hearts-container"></div>
          </div>
          
          <div class="relative z-10">
            <!-- Header -->
            <div class="mb-8">
              <div class="inline-flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-xl"></i>
                </div>
                <h1 class="text-4xl elegant-font">Heart Map</h1>
              </div>
              <p class="subtle-text mb-2">A Special Question For You</p>
            </div>
            
            <!-- Main Question -->
            <div class="mb-12">
              <div class="w-48 h-48 mx-auto mb-8 relative">
                <div class="absolute inset-0 rounded-full animate-pulse" style="background: linear-gradient(135deg, rgba(183, 110, 121, 0.1), rgba(158, 74, 90, 0.1));"></div>
                <div class="absolute inset-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-6xl heartbeat"></i>
                </div>
              </div>
              
              <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
                Will You Be My Valentine?
              </h2>
              
              <p class="text-xl subtle-text mb-6 max-w-2xl mx-auto">
                My heart has mapped its course, and it leads straight to you. 
                Will you be mine on this journey of love?
              </p>
              
              <!-- Partner's Name Display -->
              <div class="inline-block px-6 py-3 rounded-full bg-blush/30 mb-8">
                <span class="text-2xl script-font gradient-text" id="valentine-partner-name">My Dearest</span>
              </div>
            </div>
            
            <!-- Yes Button Container -->
            <div class="space-y-6 max-w-md mx-auto">
              <!-- Buttons Container -->
              <div class="flex flex-col gap-4" id="buttons-container">
                <!-- Yes Button -->
                <button id="yes-valentine-btn" class="primary-btn w-full transform hover:scale-105 transition-transform duration-300">
                  <span class="flex items-center justify-center gap-3 text-xl">
                    <i class="fas fa-heart"></i>
                    Yes, With All My Heart!
                    <i class="fas fa-heart"></i>
                  </span>
                </button>
                
                <!-- Initial NO Button (beside YES) -->
                <div id="initial-no-button-container" class="w-full flex justify-center">
                  <button id="initial-no-btn" class="no-btn w-full max-w-sm">
                    <i class="fas fa-times"></i> No Never!
                  </button>
                </div>
              </div>
              
              <!-- Secret Message (appears after clicking No a few times) -->
              <div id="secret-message" class="hidden mt-4 p-4 rounded-lg bg-rose-gold/10 border border-rose-gold/20">
                <p class="subtle-text">
                  <i class="fas fa-grin-wink mr-2"></i>
                  I know you're just being shy! The "Yes" button is waiting patiently...
                </p>
              </div>
              
              <p class="text-sm subtle-text mt-6">
                <i class="fas fa-info-circle mr-1"></i>
                Keep clicking the NO button to see it move around!
              </p>
            </div>
            
            <!-- Decorative Elements -->
            <div class="mt-12 flex items-center justify-center gap-6">
              <div class="w-6 h-6 rounded-full bg-rose-gold/30"></div>
              <div class="w-4 h-4 rounded-full bg-sage/30"></div>
              <div class="w-8 h-8 rounded-full bg-pale-pink/40"></div>
              <div class="w-4 h-4 rounded-full bg-sage/30"></div>
              <div class="w-6 h-6 rounded-full bg-rose-gold/30"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Welcome Screen -->
    <section id="welcome" class="section active">
      <div class="text-center max-w-3xl w-full fade-in">
        <div class="elegant-card mx-auto">
          <!-- Logo/Title -->
          <div class="mb-8">
            <div class="inline-flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                <i class="fas fa-heart text-white text-xl"></i>
              </div>
              <h1 class="text-4xl elegant-font">Heart Map</h1>
            </div>
            <p class="subtle-text mb-2">An Interactive Love Letter</p>
          </div>
          
          <!-- Main Heart Visual -->
          <div class="mb-10">
            <div class="relative inline-block">
              <div class="w-48 h-48 mx-auto rounded-full flex items-center justify-center gentle-pulse" style="background: linear-gradient(135deg, rgba(125, 139, 111, 0.1), rgba(183, 110, 121, 0.1));">
                <svg class="w-32 h-32" fill="url(#heartGradient)" viewBox="0 0 24 24">
                  <defs>
                    <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#7D8B6F;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#B76E79;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <div class="absolute -top-2 -right-2 w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-lg">
                <i class="fas fa-map-marker-alt text-rose-gold"></i>
              </div>
            </div>
          </div>
          
          <!-- Creator Mode Content -->
          <div id="creator-mode-content" class="creator-only">
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
              Map Your Heart
            </h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              Create a personalized, interactive love story for your special someone. 
              Every click adds to your unique journey together.
            </p>
            
            <!-- Start Button -->
            <div class="space-y-4">
              <button id="start-btn" class="primary-btn w-full max-w-sm mx-auto">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-play"></i>
                  Begin Your Heart Map
                </span>
              </button>
              
              <p class="text-sm subtle-text">
                <i class="fas fa-info-circle mr-1"></i>
                Follow the steps to create your love letter
              </p>
            </div>
          </div>
          
          <!-- Partner Mode Content -->
          <div id="partner-mode-content" class="partner-only">
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
              Welcome to My Heart Map
            </h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              You've received a special love letter!
              Created just for you by your devotee.
              Every click reveals more of my heartfelt confession.
            </p>
            
            <div class="space-y-4">
              <button id="view-letter-btn" class="primary-btn w-full max-w-sm mx-auto">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-heart"></i>
                  Open Your Love Letter
                </span>
              </button>
              
              <p class="text-sm subtle-text">
                <i class="fas fa-info-circle mr-1"></i>
                Will you explore this heartfelt message? I created it just for you, to show you what my words often struggle to say.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Greeting Section -->
    <section id="greeting" class="section">
      <div class="max-w-2xl w-full fade-in">
        <div class="elegant-card">
          <!-- Partner View Header -->
          <div class="mb-8 text-center partner-only">
            <h2 class="text-4xl elegant-font mb-4">For My Dearest <span id="partner-name-display">[Name]</span></h2>
            <p class="subtle-text">A heartfelt message just for you</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="creator-only">
            <div class="mb-8 text-center">
              <div class="inline-flex items-center gap-2 mb-4">
                <span class="completion-checkmark">1</span>
                <span class="text-sm font-medium text-sage">STEP 1 OF 4</span>
              </div>
              <h2 class="text-4xl elegant-font mb-4">To My Dearest</h2>
              <p class="subtle-text">Start by personalizing this letter with your loved one's name</p>
            </div>
            
            <div class="space-y-8">
              <div>
                <label class="block text-sm font-medium mb-2 subtle-text">Their Name</label>
                <input 
                  type="text" 
                  id="partner-name" 
                  class="elegant-input text-3xl script-font text-center editable-field"
                  placeholder="Enter their name..."
                  maxlength="30"
                >
                <p class="text-xs subtle-text mt-2 text-center">This will appear throughout your love letter</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2 subtle-text">Your Name</label>
                <input 
                  type="text" 
                  id="your-name" 
                  class="elegant-input text-2xl script-font text-center editable-field"
                  placeholder="Your name..."
                  maxlength="30"
                >
              </div>
              
              <div class="pt-6 border-t border-blush">
                <div class="flex items-center justify-between">
                  <button data-section="welcome" class="secondary-btn">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                  </button>
                  
                  <button data-section="letter" class="primary-btn" id="next-to-letter">
                    Continue to Letter
                    <i class="fas fa-arrow-right ml-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Partner View Content -->
          <div class="partner-only">
            <div class="text-center mb-8">
              <h3 class="text-3xl script-font gradient-text" id="letter-salutation-display">My Dearest <span id="partner-name-display-text">[Name]</span></h3>
            </div>
            <div class="text-center mt-12">
              <button data-section="letter" class="primary-btn">
                Read Your Love Letter
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Letter Section -->
    <section id="letter" class="section">
      <div class="max-w-3xl w-full fade-in">
        <div class="glass-card">
          <!-- Partner View Header -->
          <div class="mb-8 text-center partner-only">
            <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
            <p class="subtle-text mb-6">A message from the heart</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="mb-8 text-center creator-only">
            <div class="inline-flex items-center gap-2 mb-4">
              <span class="completion-checkmark">2</span>
              <span class="text-sm font-medium text-sage">STEP 2 OF 4</span>
            </div>
            <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
            <p class="subtle-text mb-6">Write from your heart. These words will be treasured forever.</p>
          </div>
          
          <!-- Letter Content -->
          <div class="space-y-6">
            <!-- Date -->
            <div class="text-right">
              <input 
                type="text" 
                id="letter-date" 
                class="elegant-input text-right max-w-xs ml-auto editable-field creator-only"
                placeholder="Today's date..."
                value="February 14, 2026"
              >
              <p id="letter-date-display" class="partner-only subtle-text text-lg"></p>
            </div>
            
            <!-- Salutation -->
            <div class="text-center mb-8">
              <h3 class="text-3xl script-font gradient-text" id="letter-salutation">My Dearest <span id="letter-partner-name">[Name]</span></h3>
            </div>
            
            <!-- Letter Body -->
            <div class="space-y-8">
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">Opening</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">My Dearest</p>
                </div>
                <textarea 
                  id="letter-opening"
                  class="w-full elegant-input min-h-[100px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="My love, the moment I met you..."
                  rows="3"
                ></textarea>
                <div id="letter-opening-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">What I Love About You</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">What I Love About You</p>
                </div>
                <textarea 
                  id="letter-body"
                  class="w-full elegant-input min-h-[150px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="I love the way you... Your smile reminds me of... The thing I cherish most is..."
                  rows="5"
                ></textarea>
                <div id="letter-body-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">My Promise to You</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">My Promise to You</p>
                </div>
                <textarea 
                  id="letter-promise"
                  class="w-full elegant-input min-h-[100px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="I promise to always... Together, we will..."
                  rows="3"
                ></textarea>
                <div id="letter-promise-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">Closing</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">With All My Love</p>
                </div>
                <textarea 
                  id="letter-closing"
                  class="w-full elegant-input min-h-[80px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="With all my love and admiration..."
                  rows="2"
                ></textarea>
                <div id="letter-closing-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
            </div>
            
            <!-- Signature -->
            <div class="text-center mt-12 pt-8 border-t border-blush">
              <div class="mb-4">
                <span class="text-3xl script-font gradient-text" id="letter-signature">[Your Name]</span>
                <span id="letter-signature-display" class="partner-only text-3xl script-font gradient-text"></span>
              </div>
              <p class="text-sm subtle-text italic">Forever yours</p>
            </div>
            
            <!-- Navigation -->
            <div class="flex items-center justify-between pt-8">
              <!-- Creator Navigation -->
              <button data-section="greeting" class="secondary-btn creator-only">
                <i class="fas fa-arrow-left mr-2"></i>Back
              </button>
              
              <button data-section="memories" class="primary-btn creator-only">
                Add Memories
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
              
              <!-- Partner Navigation -->
              <button data-section="greeting" class="secondary-btn partner-only">
                <i class="fas fa-arrow-left mr-2"></i>Previous
              </button>
              
              <button data-section="memories" class="primary-btn partner-only">
                View Memories
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Memories Section -->
    <section id="memories" class="section">
      <div class="max-w-6xl w-full fade-in">
        <div class="glass-card">
          <!-- Partner View Header -->
          <div class="mb-10 text-center partner-only">
            <h2 class="text-4xl elegant-font mb-4">Our Treasured Moments</h2>
            <p class="subtle-text mb-6">Special memories we've shared together</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="creator-only">
            <div class="mb-10 text-center">
              <div class="inline-flex items-center gap-2 mb-4">
                <span class="completion-checkmark">3</span>
                <span class="text-sm font-medium text-sage">STEP 3 OF 4</span>
              </div>
              <h2 class="text-4xl elegant-font mb-4">Our Treasured Moments</h2>
              <p class="subtle-text mb-6">Add photos and memories that tell our story</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <!-- Memory 1 -->
            <div class="group">
              <div class="aspect-square rounded-2xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center p-6 cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only memory-container" id="memory-1">
                <div class="text-center">
                  <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                    <i class="fas fa-camera text-white text-xl"></i>
                  </div>
                  <h4 class="font-medium mb-2">Our First Memory</h4>
                  <p class="text-sm subtle-text mb-4">Click to add a photo</p>
                </div>
              </div>
              <div class="aspect-square rounded-2xl overflow-hidden partner-only memory-display" id="memory-1-display">
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blush/20 to-pale-pink/20">
                  <div class="text-center p-6">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                      <i class="fas fa-heart text-white text-xl"></i>
                    </div>
                    <h4 class="font-medium mb-2">Our First Memory</h4>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <textarea 
                  id="memory-1-text"
                  class="memory-description creator-only"
                  placeholder="Describe this special moment..."
                  rows="2"
                ></textarea>
                <div id="memory-1-text-display" class="partner-only text-center subtle-text p-3"></div>
              </div>
            </div>
            
            <!-- Memory 2 -->
            <div class="group">
              <div class="aspect-square rounded-2xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center p-6 cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only memory-container" id="memory-2">
                <div class="text-center">
                  <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--sage), var(--moss));">
                    <i class="fas fa-heart text-white text-xl"></i>
                  </div>
                  <h4 class="font-medium mb-2">A Happy Moment</h4>
                  <p class="text-sm subtle-text mb-4">Click to add a photo</p>
                </div>
              </div>
              <div class="aspect-square rounded-2xl overflow-hidden partner-only memory-display" id="memory-2-display">
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blush/20 to-pale-pink/20">
                  <div class="text-center p-6">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--sage), var(--moss));">
                      <i class="fas fa-heart text-white text-xl"></i>
                    </div>
                    <h4 class="font-medium mb-2">A Happy Moment</h4>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <textarea 
                  id="memory-2-text"
                  class="memory-description creator-only"
                  placeholder="What made this day special?"
                  rows="2"
                ></textarea>
                <div id="memory-2-text-display" class="partner-only text-center subtle-text p-3"></div>
              </div>
            </div>
            
            <!-- Memory 3 -->
            <div class="group">
              <div class="aspect-square rounded-2xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center p-6 cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only memory-container" id="memory-3">
                <div class="text-center">
                  <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--rose-gold), var(--soft-pink));">
                    <i class="fas fa-star text-white text-xl"></i>
                  </div>
                  <h4 class="font-medium mb-2">Looking Forward</h4>
                  <p class="text-sm subtle-text mb-4">Click to add a photo</p>
                </div>
              </div>
              <div class="aspect-square rounded-2xl overflow-hidden partner-only memory-display" id="memory-3-display">
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blush/20 to-pale-pink/20">
                  <div class="text-center p-6">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, var(--rose-gold), var(--soft-pink));">
                      <i class="fas fa-star text-white text-xl"></i>
                    </div>
                    <h4 class="font-medium mb-2">Looking Forward</h4>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <textarea 
                  id="memory-3-text"
                  class="memory-description creator-only"
                  placeholder="Our dreams for the future..."
                  rows="2"
                ></textarea>
                <div id="memory-3-text-display" class="partner-only text-center subtle-text p-3"></div>
              </div>
            </div>
          </div>
          
          <!-- Music Player -->
          <div class="mb-10">
            <div class="max-w-md mx-auto">
              <div class="text-center mb-6">
                <h3 class="text-xl elegant-font mb-2">Our Song</h3>
                <p class="subtle-text text-sm creator-only">Add a song that reminds you of them</p>
                <p class="subtle-text text-sm partner-only">A special song for us</p>
              </div>
              
              <div class="bg-white rounded-xl p-6 shadow-sm border border-blush">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <div id="song-title" class="font-medium">No song selected</div>
                    <div id="song-status" class="text-sm subtle-text">Upload an MP3 file</div>
                  </div>
                  <button id="upload-song-btn" class="secondary-btn editable-field creator-only">
                    <i class="fas fa-upload mr-2"></i>Upload
                  </button>
                </div>
                
                <div class="flex items-center justify-center gap-4">
                  <button id="prev-btn" class="w-10 h-10 rounded-full border border-blush flex items-center justify-center hover:bg-blush/20 editable-field">
                    <i class="fas fa-step-backward"></i>
                  </button>
                  
                  <button id="play-btn" class="w-14 h-14 rounded-full primary-btn flex items-center justify-center editable-field">
                    <i id="play-icon" class="fas fa-play"></i>
                    <i id="pause-icon" class="fas fa-pause hidden"></i>
                  </button>
                  
                  <button id="next-btn" class="w-10 h-10 rounded-full border border-blush flex items-center justify-center hover:bg-blush/20 editable-field">
                    <i class="fas fa-step-forward"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Navigation -->
          <div class="flex items-center justify-between pt-8 border-t border-blush">
            <!-- Creator Navigation -->
            <button data-section="letter" class="secondary-btn creator-only">
              <i class="fas fa-arrow-left mr-2"></i>Back to Letter
            </button>
            
            <button data-section="final" class="primary-btn creator-only">
              Preview & Share
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
            
            <!-- Partner Navigation -->
            <button data-section="letter" class="secondary-btn partner-only">
              <i class="fas fa-arrow-left mr-2"></i>Back
            </button>
            
            <button data-section="final" class="primary-btn partner-only">
              Continue
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Final & Share Section -->
    <section id="final" class="section">
      <div class="max-w-3xl w-full fade-in">
        <div class="elegant-card">
          <!-- Partner View -->
          <div class="partner-only text-center">
            <div class="mb-8">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                <i class="fas fa-heart text-white text-2xl"></i>
              </div>
              <h2 class="text-5xl elegant-font mb-4 gradient-text">Thank You</h2>
              <p class="subtle-text text-lg mb-6">For exploring this Heart Map made just for you</p>
              
              <div class="bg-gradient-to-r from-rose-gold/10 to-sage/10 p-6 rounded-xl mb-6">
                <h3 class="text-xl elegant-font mb-4">ðŸ’– Create Your Own Response ðŸ’–</h3>
                <p class="subtle-text mb-4">Now you can create your own Heart Map to send back</p>
                <button id="create-your-own-btn" class="primary-btn">
                  <i class="fas fa-heart mr-2"></i>
                  Create Your Heart Map
                </button>
              </div>
            </div>
          </div>
          
          <!-- Creator View -->
          <div class="creator-only">
            <div class="text-center mb-10">
              <div class="inline-flex items-center gap-2 mb-4">
                <span class="completion-checkmark">4</span>
                <span class="text-sm font-medium text-sage">STEP 4 OF 4 - COMPLETE!</span>
              </div>
              
              <div class="mb-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h2 class="text-5xl elegant-font mb-4 gradient-text">Your Heart Map is Ready!</h2>
                <p class="subtle-text text-lg">Preview your creation before sharing it with your loved one</p>
              </div>
            </div>
            
            <!-- Preview Card -->
            <div class="mb-10">
              <div class="bg-gradient-to-br from-blush/20 to-pale-pink/10 rounded-2xl p-8 border border-blush">
                <div class="flex items-center justify-between mb-6">
                  <div>
                    <h3 class="text-2xl elegant-font">Preview</h3>
                    <p class="subtle-text">This is what your partner will see</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-rose-gold animate-pulse"></div>
                    <span class="text-sm font-medium">View Only Mode</span>
                  </div>
                </div>
                
                <div class="space-y-6">
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Personalized greeting for <span id="preview-name" class="font-medium">[Name]</span></span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Love letter with <span id="preview-letter-length" class="font-medium">0</span> words</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span><span id="preview-photo-count" class="font-medium">0</span> memory photos</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Personal soundtrack included</span>
                  </div>
                </div>
                
                <!-- Live Preview Button -->
                <div class="mt-8 pt-6 border-t border-blush">
                  <button id="live-preview-btn" class="primary-btn w-full">
                    <i class="fas fa-eye mr-2"></i>
                    View Live Preview
                  </button>
                  <p class="text-sm subtle-text mt-2 text-center">See exactly what your partner will experience</p>
                </div>
              </div>
            </div>
            
            <!-- Important Note -->
            <div class="mb-10 p-6 rounded-xl bg-gradient-to-r from-rose-gold/5 to-sage/5 border border-rose-gold/20">
              <div class="flex items-start gap-3">
                <i class="fas fa-lock mt-1 text-rose-gold"></i>
                <div>
                  <h4 class="font-medium mb-2">Important: View-Only Mode</h4>
                  <p class="text-sm subtle-text">
                    Once shared, your Heart Map becomes <span class="font-medium">view-only</span> for your partner. 
                    They can experience your love story but cannot edit it. At the end, they'll have the option to create their own Heart Map for you.
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Share Buttons -->
            <div class="space-y-4 mb-8">
              <h3 class="text-xl elegant-font text-center">Share Your Heart Map</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="whatsapp-share" class="secondary-btn flex items-center justify-center gap-3 editable-field">
                  <i class="fab fa-whatsapp text-green-500 text-lg"></i>
                  Share via WhatsApp
                </button>
                
                <button id="copy-link" class="secondary-btn flex items-center justify-center gap-3 editable-field">
                  <i class="fas fa-link text-rose-gold text-lg"></i>
                  Copy Link
                </button>
              </div>
              
              <div class="text-center">
                <button id="save-draft" class="text-sm subtle-text hover:text-rose-gold transition-colors editable-field">
                  <i class="fas fa-save mr-1"></i>
                  Save as draft to continue later
                </button>
              </div>
            </div>
            
            <!-- Partner's View Section -->
            <div id="partner-view-section" class="hidden">
              <div class="text-center pt-8 border-t border-blush">
                <p class="subtle-text mb-4">You've received this beautiful Heart Map from <span id="partner-sender-name" class="font-medium">[Sender]</span></p>
                <div class="bg-gradient-to-r from-rose-gold/10 to-sage/10 p-6 rounded-xl mb-6">
                  <h3 class="text-xl elegant-font mb-4">ðŸ’– A Message From Your Valentine ðŸ’–</h3>
                  <p id="partner-preview-text" class="subtle-text italic"></p>
                </div>
                <button id="create-response-btn" class="primary-btn">
                  <i class="fas fa-heart mr-2"></i>
                  Create Your Response Heart Map
                </button>
                <p class="text-xs subtle-text mt-3">Send a heartfelt response to complete the circle of love</p>
              </div>
            </div>
            
            <!-- Final Navigation -->
            <div class="flex items-center justify-between pt-8 border-t border-blush">
              <button data-section="memories" class="secondary-btn">
                <i class="fas fa-edit mr-2"></i>Edit
              </button>
              
              <div class="flex items-center gap-2 subtle-text">
                <i class="fas fa-info-circle"></i>
                <span class="text-sm">All data is saved locally in your browser</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Hidden File Inputs -->
  <input type="file" id="image-upload" class="hidden" accept="image/*">
  <input type="file" id="audio-upload" class="hidden" accept="audio/*">
  <audio id="audio-player" class="hidden"></audio>
  
  <script>
    // ========== STATE MANAGEMENT ==========
    const HeartMapState = {
      isCreator: true,
      isViewOnly: false,
      currentSection: 'welcome',
      completedSections: new Set(['welcome']),
      data: {
        partnerName: '',
        yourName: '',
        letter: {
          date: 'February 14, 2026',
          opening: '',
          body: '',
          promise: '',
          closing: ''
        },
        memories: [{}, {}, {}],
        song: null
      },
      save() {
        localStorage.setItem('heartMapData', JSON.stringify(this.data));
        localStorage.setItem('heartMapCompleted', JSON.stringify([...this.completedSections]));
        localStorage.setItem('heartMapCreator', this.isCreator.toString());
        return this.generateShareId();
      },
      load() {
        const saved = localStorage.getItem('heartMapData');
        const completed = localStorage.getItem('heartMapCompleted');
        const creator = localStorage.getItem('heartMapCreator');
        if (saved) this.data = JSON.parse(saved);
        if (completed) this.completedSections = new Set(JSON.parse(completed));
        if (creator) this.isCreator = creator === 'true';
        return this;
      },
      reset() {
        this.data = {
          partnerName: '',
          yourName: '',
          letter: {
            date: 'February 14, 2026',
            opening: '',
            body: '',
            promise: '',
            closing: ''
          },
          memories: [{}, {}, {}],
          song: null
        };
        this.completedSections = new Set(['welcome']);
        this.isCreator = true;
        this.save();
      },
      generateShareId() {
        // Generate a unique ID for sharing
        const shareId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('heartMapShareId', shareId);
        
        // Save the current data with this ID
        const shareData = {
          id: shareId,
          data: JSON.stringify(this.data),
          completed: JSON.stringify([...this.completedSections]),
          timestamp: Date.now()
        };
        
        localStorage.setItem(`heartMap_${shareId}`, JSON.stringify(shareData));
        
        // Clean up old shares
        this.cleanupOldShares();
        
        return shareId;
      },
      loadFromShareId(shareId) {
        const shareKey = `heartMap_${shareId}`;
        const shareData = localStorage.getItem(shareKey);
        
        if (shareData) {
          try {
            const parsed = JSON.parse(shareData);
            
            if (parsed.data) {
              this.data = JSON.parse(parsed.data);
            }
            if (parsed.completed) {
              this.completedSections = new Set(JSON.parse(parsed.completed));
            }
            
            this.isCreator = false;
            this.isViewOnly = true;
            return true;
          } catch (e) {
            console.error('Error loading shared data:', e);
            return false;
          }
        }
        return false;
      },
      cleanupOldShares() {
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000); // 24 hours
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('heartMap_') && key !== 'heartMapData' && 
              key !== 'heartMapCompleted' && key !== 'heartMapCreator' && key !== 'heartMapShareId') {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data.timestamp && data.timestamp < oneDayAgo) {
                localStorage.removeItem(key);
              }
            } catch (e) {
              // Ignore errors
            }
          }
        }
      }
    };

    // List of NO button phrases
    const noButtonPhrases = [
      "No Pushing Me Away ðŸ˜",
      "Maybe later ðŸ¤ª",
      "Try Again ðŸ˜›",
      "Are You Sure? ðŸ¥º",
      "Can we talk first? ðŸ˜­",
      "Please Think Again ðŸ˜­",
      "Are You Perhaps Shy? ðŸ¤­",
      "Nah, Not This Easily ðŸ˜",
      "Let's think thoroughly ðŸ¥º ",
      "Come on, baby ðŸ¥º",
      "You Are Tired Of Saying No ðŸ˜¹"
    ];
    
    // Track NO button state
    let noButtonClickCount = 0;
    let isNoButtonFloating = false;
    let currentNoButton = null;
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved state
      HeartMapState.load();
      
      // Check if viewing as partner via share ID
      const urlParams = new URLSearchParams(window.location.search);
      const shareId = urlParams.get('id');
      
      if (shareId) {
        // Try to load shared data
        const success = HeartMapState.loadFromShareId(shareId);
        
        if (success) {
          document.body.classList.add('view-only');
          document.body.classList.remove('creator-mode');
          
          // Update partner view with creator's data
          updatePartnerView();
          
          // Set up partner mode navigation
          document.getElementById('view-letter-btn').addEventListener('click', () => {
            navigateToSection('greeting');
          });
          
          // Set current section to valentine question
          HeartMapState.currentSection = 'valentine-question';
          
          // Initialize Valentine screen first
          initValentineScreen();
        } else {
          // If no shared data found, show error and redirect to creator mode
          alert('This Heart Map link has expired or is invalid. Creating a new one...');
          HeartMapState.reset();
          document.body.classList.add('creator-mode');
        }
      } else {
        // Creator mode
        document.body.classList.add('creator-mode');
        document.body.classList.remove('view-only');
        
        // Generate share ID if none exists
        if (!localStorage.getItem('heartMapShareId')) {
          HeartMapState.generateShareId();
        }
      }
      
      // Initialize components
      initFloatingElements();
      initNavigation();
      initFormBindings();
      initMediaUpload();
      initMemoryTextBindings();
      initMusicPlayer();
      initShareFunctions();
      initPreviewFunctions();
      initPreviewUpdates();
      
      // Update UI based on state
      updateUIFromState();
      updateProgress();
      
      // Show the current section
      showCurrentSection();
      
      console.log('Heart Map initialized');
    });
    
    // ========== PREVIEW FUNCTIONS ==========
    function initPreviewFunctions() {
      // Live preview button
      document.getElementById('live-preview-btn').addEventListener('click', showLivePreview);
      
      // Close preview button
      document.getElementById('close-preview').addEventListener('click', closePreview);
    }
    
    function showLivePreview() {
      // Save current state
      HeartMapState.save();
      
      // Create preview container
      const previewContainer = document.getElementById('preview-container');
      const previewContent = document.getElementById('preview-content');
      
      // Generate HTML for partner view
      let previewHTML = '';
      
      // Valentine screen
      if (HeartMapState.data.partnerName) {
        previewHTML += `
          <div class="text-center max-w-3xl w-full mx-auto mb-8">
            <div class="elegant-card">
              <div class="mb-8">
                <div class="inline-flex items-center gap-3 mb-6">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                    <i class="fas fa-heart text-white text-xl"></i>
                  </div>
                  <h1 class="text-4xl elegant-font">Heart Map</h1>
                </div>
                <p class="subtle-text mb-2">A Special Question For You</p>
              </div>
              
              <div class="mb-12">
                <div class="w-48 h-48 mx-auto mb-8 relative">
                  <div class="absolute inset-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                    <i class="fas fa-heart text-white text-6xl heartbeat"></i>
                  </div>
                </div>
                
                <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">Will You Be My Valentine?</h2>
                
                <p class="text-xl subtle-text mb-6 max-w-2xl mx-auto">
                  My heart has mapped its course, and it leads straight to you. 
                  Will you be mine on this journey of love?
                </p>
                
                <div class="inline-block px-6 py-3 rounded-full bg-blush/30 mb-8">
                  <span class="text-2xl script-font gradient-text">${HeartMapState.data.partnerName || 'My Dearest'}</span>
                </div>
              </div>
              
              <div class="space-y-6 max-w-md mx-auto">
                <button class="primary-btn w-full">
                  <span class="flex items-center justify-center gap-3 text-xl">
                    <i class="fas fa-heart"></i>
                    Yes, With All My Heart!
                    <i class="fas fa-heart"></i>
                  </span>
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // Welcome screen
      previewHTML += `
        <div class="text-center max-w-3xl w-full mx-auto mb-8">
          <div class="elegant-card">
            <div class="mb-8">
              <div class="inline-flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-heart text-white text-xl"></i>
                </div>
                <h1 class="text-4xl elegant-font">Heart Map</h1>
              </div>
              <p class="subtle-text mb-2">An Interactive Love Letter</p>
            </div>
            
            <div class="mb-10">
              <div class="relative inline-block">
                <div class="w-48 h-48 mx-auto rounded-full flex items-center justify-center gentle-pulse" style="background: linear-gradient(135deg, rgba(125, 139, 111, 0.1), rgba(183, 110, 121, 0.1));">
                  <svg class="w-32 h-32" fill="url(#heartGradient)" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">Welcome to My Heart Map</h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              You've received a special love letter! Created just for you by your devotee.
              Every click reveals more of my heartfelt confession.
            </p>
            
            <div class="space-y-4">
              <button class="primary-btn w-full max-w-sm mx-auto">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-heart"></i>
                  Open Your Love Letter
                </span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Letter preview
      previewHTML += `
        <div class="max-w-3xl w-full mx-auto mb-8">
          <div class="glass-card">
            <div class="mb-8 text-center">
              <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
              <p class="subtle-text mb-6">A message from the heart</p>
            </div>
            
            <div class="space-y-6">
              <div class="text-right">
                <p class="subtle-text text-lg">${HeartMapState.data.letter.date || 'February 14, 2026'}</p>
              </div>
              
              <div class="text-center mb-8">
                <h3 class="text-3xl script-font gradient-text">My Dearest ${HeartMapState.data.partnerName || '[Name]'}</h3>
              </div>
              
              <div class="space-y-8">
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.opening || 'My love, the moment I met you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.body || 'I love everything about you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.promise || 'I promise to always love you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.closing || 'With all my love...'}</p>
                </div>
              </div>
              
              <div class="text-center mt-12 pt-8 border-t border-blush">
                <div class="mb-4">
                  <span class="text-3xl script-font gradient-text">${HeartMapState.data.yourName || 'Your Valentine'}</span>
                </div>
                <p class="text-sm subtle-text italic">Forever yours</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Memories preview
      previewHTML += `
        <div class="max-w-6xl w-full mx-auto mb-8">
          <div class="glass-card">
            <div class="mb-10 text-center">
              <h2 class="text-4xl elegant-font mb-4">Our Treasured Moments</h2>
              <p class="subtle-text mb-6">Special memories we've shared together</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
      `;
      
      // Add memory previews
      for (let i = 0; i < 3; i++) {
        const memory = HeartMapState.data.memories[i] || {};
        previewHTML += `
          <div class="group">
            <div class="aspect-square rounded-2xl overflow-hidden">
              ${memory.image ? 
                `<img src="${memory.image}" class="w-full h-full object-cover rounded-2xl" alt="Memory ${i+1}">` : 
                `<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blush/20 to-pale-pink/20">
                  <div class="text-center p-6">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: linear-gradient(135deg, ${i === 0 ? 'var(--rose-gold), var(--deep-pink)' : i === 1 ? 'var(--sage), var(--moss)' : 'var(--rose-gold), var(--soft-pink)'});">
                      <i class="fas fa-${i === 0 ? 'camera' : i === 1 ? 'heart' : 'star'} text-white text-xl"></i>
                    </div>
                    <h4 class="font-medium mb-2">${i === 0 ? 'Our First Memory' : i === 1 ? 'A Happy Moment' : 'Looking Forward'}</h4>
                  </div>
                </div>`
              }
            </div>
            <div class="mt-4">
              <div class="text-center subtle-text p-3">${memory.caption || ''}</div>
            </div>
          </div>
        `;
      }
      
      previewHTML += `
            </div>
          </div>
        </div>
      `;
      
      // Final screen preview
      previewHTML += `
        <div class="max-w-3xl w-full mx-auto">
          <div class="elegant-card">
            <div class="text-center">
              <div class="mb-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-heart text-white text-2xl"></i>
                </div>
                <h2 class="text-5xl elegant-font mb-4 gradient-text">Thank You</h2>
                <p class="subtle-text text-lg mb-6">For exploring this Heart Map made just for you</p>
                
                <div class="bg-gradient-to-r from-rose-gold/10 to-sage/10 p-6 rounded-xl mb-6">
                  <h3 class="text-xl elegant-font mb-4">ðŸ’– Create Your Own Response ðŸ’–</h3>
                  <p class="subtle-text mb-4">Now you can create your own Heart Map to send back</p>
                  <button class="primary-btn">
                    <i class="fas fa-heart mr-2"></i>
                    Create Your Heart Map
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      previewContent.innerHTML = previewHTML;
      previewContainer.classList.add('active');
    }
    
    function closePreview() {
      document.getElementById('preview-container').classList.remove('active');
    }
    
    // ========== VALENTINE QUESTION SCREEN ==========
    function initValentineScreen() {
      // Only show if viewing as partner
      if (HeartMapState.isViewOnly && !HeartMapState.isCreator) {
        // Navigate to valentine question screen
        navigateToSection('valentine-question');
        
        // Update partner name if available
        if (HeartMapState.data.partnerName) {
          document.getElementById('valentine-partner-name').textContent = HeartMapState.data.partnerName;
        }
        
        // Create floating hearts for background
        createValentineHearts();
        setInterval(createValentineHearts, 2000);
        
        // Set up the YES button
        const yesBtn = document.getElementById('yes-valentine-btn');
        const initialNoBtn = document.getElementById('initial-no-btn');
        const secretMessage = document.getElementById('secret-message');
        
        // Yes button - takes them to the actual content
        yesBtn.addEventListener('click', () => {
          // Create celebration effect
          createCelebration();
          
          // Show success message
          showNotification('ðŸ’– Yes! You\'ve made my heart complete! ðŸ’–');
          
          // Remove all NO buttons
          if (currentNoButton) {
            currentNoButton.remove();
          }
          initialNoBtn.remove();
          
          // Navigate to welcome screen after a delay
          setTimeout(() => {
            navigateToSection('welcome');
          }, 1500);
        });
        
        // Initial NO button (beside YES)
        initialNoBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          noButtonClickCount++;
          
          // Vibrate on mobile
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          
          // After first click, move NO button to random position
          if (noButtonClickCount === 1) {
            // Hide the initial NO button
            this.style.opacity = '0';
            this.style.transform = 'scale(0.8)';
            
            // Create floating NO button
            setTimeout(() => {
              this.style.display = 'none';
              createFloatingNoButton();
            }, 300);
          }
          
          // Update secret message after 3 clicks
          if (noButtonClickCount >= 3 && !secretMessage.classList.contains('show')) {
            secretMessage.classList.remove('hidden');
            secretMessage.classList.add('show');
            secretMessage.style.animation = 'fadeIn 0.5s ease-out';
          }
        });
      }
    }
    
    function createFloatingNoButton() {
      // Remove existing floating NO button if any
      if (currentNoButton) {
        currentNoButton.remove();
      }
      
      const container = document.getElementById('no-button-container');
      const randomPhrase = noButtonPhrases[Math.floor(Math.random() * noButtonPhrases.length)];
      
      currentNoButton = document.createElement('button');
      currentNoButton.className = 'no-btn';
      currentNoButton.innerHTML = `<i class="fas fa-times"></i> ${randomPhrase}`;
      currentNoButton.title = randomPhrase;
      
      // Random position (not too close to edges)
      const maxX = window.innerWidth - 200;
      const maxY = window.innerHeight - 100;
      const randomX = Math.floor(Math.random() * maxX) + 50;
      const randomY = Math.floor(Math.random() * maxY) + 50;
      
      currentNoButton.style.left = `${randomX}px`;
      currentNoButton.style.top = `${randomY}px`;
      
      // Add click event
      currentNoButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        noButtonClickCount++;
        
        // Vibrate on mobile
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        
        // Change phrase
        const newPhrase = noButtonPhrases[Math.floor(Math.random() * noButtonPhrases.length)];
        this.innerHTML = `<i class="fas fa-times"></i> ${newPhrase}`;
        this.title = newPhrase;
        
        // Move to new random position
        const newX = Math.floor(Math.random() * maxX) + 50;
        const newY = Math.floor(Math.random() * maxY) + 50;
        
        // Animate movement
        this.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        this.style.left = `${newX}px`;
        this.style.top = `${newY}px`;
        
        // Update secret message after 3 clicks
        const secretMessage = document.getElementById('secret-message');
        if (noButtonClickCount >= 3 && !secretMessage.classList.contains('show')) {
          secretMessage.classList.remove('hidden');
          secretMessage.classList.add('show');
          secretMessage.style.animation = 'fadeIn 0.5s ease-out';
        }
      });
      
      container.appendChild(currentNoButton);
      isNoButtonFloating = true;
    }
    
    function createValentineHearts() {
      const container = document.getElementById('valentine-hearts-container');
      const heartTypes = ['ðŸ’–', 'ðŸ’—', 'ðŸ’“', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’˜', 'ðŸ’', 'ðŸ§¡'];
      
      for (let i = 0; i < 8; i++) {
        const heart = document.createElement('div');
        const type = heartTypes[Math.floor(Math.random() * heartTypes.length)];
        
        heart.textContent = type;
        heart.className = 'absolute pointer-events-none';
        heart.style.fontSize = `${Math.random() * 20 + 16}px`;
        heart.style.opacity = Math.random() * 0.3 + 0.1;
        heart.style.left = `${Math.random() * 100}%`;
        heart.style.top = `${Math.random() * 100}%`;
        heart.style.color = getRandomPink();
        heart.style.animation = `floatUp ${Math.random() * 20 + 10}s linear infinite`;
        heart.style.animationDelay = `${Math.random() * 5}s`;
        
        container.appendChild(heart);
        
        // Remove after animation completes
        setTimeout(() => {
          if (heart.parentElement === container) {
            container.removeChild(heart);
          }
        }, 30000);
      }
    }
    
    function createCelebration() {
      const container = document.getElementById('floating-container');
      const celebrations = ['ðŸŽ‰', 'âœ¨', 'ðŸŒŸ', 'ðŸ’«', 'ðŸ¥³', 'ðŸŽŠ', 'ðŸ’–', 'ðŸ’'];
      
      for (let i = 0; i < 20; i++) {
        const celeb = document.createElement('div');
        const type = celebrations[Math.floor(Math.random() * celebrations.length)];
        
        celeb.textContent = type;
        celeb.className = 'fixed pointer-events-none z-50';
        celeb.style.fontSize = `${Math.random() * 24 + 20}px`;
        celeb.style.opacity = '1';
        celeb.style.left = `${Math.random() * 100}vw`;
        celeb.style.top = `${Math.random() * 100}vh`;
        celeb.style.animation = `floatUp ${Math.random() * 2 + 1}s ease-out forwards`;
        
        container.appendChild(celeb);
        setTimeout(() => celeb.remove(), 2000);
      }
    }
    
    // ========== UPDATE PARTNER VIEW ==========
    function updatePartnerView() {
      // Update display elements with loaded data
      document.getElementById('partner-name-display').textContent = HeartMapState.data.partnerName || 'My Love';
      document.getElementById('partner-name-display-text').textContent = HeartMapState.data.partnerName || 'My Love';
      document.getElementById('letter-date-display').textContent = HeartMapState.data.letter.date || 'February 14, 2026';
      
      // Update letter content displays
      document.getElementById('letter-opening-display').textContent = HeartMapState.data.letter.opening || 'My love, the moment I met you...';
      document.getElementById('letter-body-display').textContent = HeartMapState.data.letter.body || 'I love everything about you...';
      document.getElementById('letter-promise-display').textContent = HeartMapState.data.letter.promise || 'I promise to always love you...';
      document.getElementById('letter-closing-display').textContent = HeartMapState.data.letter.closing || 'With all my love...';
      document.getElementById('letter-signature-display').textContent = HeartMapState.data.yourName || 'Your Valentine';
      
      // Update memory displays
      for (let i = 0; i < 3; i++) {
        if (HeartMapState.data.memories[i] && HeartMapState.data.memories[i].image) {
          const memoryDisplay = document.getElementById(`memory-${i+1}-display`);
          if (memoryDisplay) {
            memoryDisplay.innerHTML = `
              <img src="${HeartMapState.data.memories[i].image}" 
                   class="w-full h-full object-cover rounded-2xl"
                   alt="Memory ${i+1}">
            `;
          }
        }
        if (HeartMapState.data.memories[i] && HeartMapState.data.memories[i].caption) {
          const textDisplay = document.getElementById(`memory-${i+1}-text-display`);
          if (textDisplay) {
            textDisplay.textContent = HeartMapState.data.memories[i].caption;
          }
        }
      }
      
      // Set up create your own button
      const createYourOwnBtn = document.getElementById('create-your-own-btn');
      if (createYourOwnBtn) {
        createYourOwnBtn.addEventListener('click', function() {
          // Reset state for response
          HeartMapState.reset();
          HeartMapState.data.partnerName = HeartMapState.data.yourName; // Set partner to original sender
          HeartMapState.save();
          
          // Remove view-only mode
          document.body.classList.remove('view-only');
          document.body.classList.add('creator-mode');
          
          // Navigate to greeting section
          navigateToSection('greeting');
          
          // Show notification
          showNotification('ðŸ’Œ Creating a response Heart Map for your Valentine!');
        });
      }
    }
    
    // ========== SHARE FUNCTIONS ==========
    function initShareFunctions() {
      // WhatsApp share - FIXED: Proper share URL generation
      document.getElementById('whatsapp-share').addEventListener('click', () => {
        // First, ensure all data is saved and get share ID
        const shareId = HeartMapState.save(); // This saves and returns the share ID
        
        if (!shareId) {
          showNotification('âŒ Please save your Heart Map first!');
          return;
        }
        
        // Generate the share URL - FIXED: Use the correct format
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?id=${shareId}`;
        
        const text = `ðŸ’– I created a Heart Map love letter just for you! ðŸ’–\n\nClick the link to view my heartfelt message:\n${shareUrl}`;
        const encodedText = encodeURIComponent(text);
        const whatsappUrl = `https://wa.me/?text=${encodedText}`;
        
        // Open in new window
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        
        showNotification('ðŸ“± Opening WhatsApp to share your Heart Map!');
      });
      
      // Copy link - FIXED: Proper share URL generation
      document.getElementById('copy-link').addEventListener('click', async () => {
        // First, ensure all data is saved and get share ID
        const shareId = HeartMapState.save(); // This saves and returns the share ID
        
        if (!shareId) {
          showNotification('âŒ Please save your Heart Map first!');
          return;
        }
        
        // Generate the share URL - FIXED: Use the correct format
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?id=${shareId}`;
        
        try {
          await navigator.clipboard.writeText(shareUrl);
          
          // Visual feedback
          const btn = document.getElementById('copy-link');
          const originalHTML = btn.innerHTML;
          const originalBg = btn.style.background;
          
          btn.innerHTML = '<i class="fas fa-check"></i> Link Copied!';
          btn.style.background = 'linear-gradient(135deg, var(--sage), var(--deep-sage))';
          btn.classList.add('success-pulse');
          
          showNotification('âœ… Link copied to clipboard! Send this to your partner.');
          
          // Reset button after 2 seconds
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.style.background = originalBg;
            btn.classList.remove('success-pulse');
          }, 2000);
          
        } catch (err) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = shareUrl;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            document.execCommand('copy');
            showNotification('âœ… Link copied to clipboard! Send this to your partner.');
          } catch (e) {
            showNotification('âŒ Failed to copy link. Please try again.');
          }
          
          document.body.removeChild(textArea);
        }
      });
      
      // Save draft
      document.getElementById('save-draft').addEventListener('click', () => {
        HeartMapState.save();
        showNotification('ðŸ’¾ Draft saved! You can continue anytime.');
      });
      
      // Add hover preview for share buttons
      initSharePreview();
    }
    
    function initSharePreview() {
      const copyBtn = document.getElementById('copy-link');
      const whatsappBtn = document.getElementById('whatsapp-share');
      
      copyBtn.addEventListener('mouseenter', () => {
        const shareId = localStorage.getItem('heartMapShareId');
        if (shareId) {
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?id=${shareId}`;
          copyBtn.title = `Click to copy:\n${shareUrl}`;
        }
      });
      
      whatsappBtn.addEventListener('mouseenter', () => {
        const shareId = localStorage.getItem('heartMapShareId');
        if (shareId) {
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?id=${shareId}`;
          whatsappBtn.title = `Share via WhatsApp:\n${shareUrl}`;
        }
      });
    }
    
    function showNotification(message) {
      // Remove existing notifications
      document.querySelectorAll('.heartmap-notification').forEach(el => el.remove());
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'heartmap-notification fixed top-6 right-6 bg-white rounded-lg shadow-lg p-4 border-l-4 border-rose-gold z-50 max-w-sm';
      notification.style.animation = 'fadeIn 0.3s ease-out';
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-rose-gold/10 flex items-center justify-center">
            <i class="fas fa-info-circle text-rose-gold"></i>
          </div>
          <div>
            <p class="font-medium">${message}</p>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 4 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(20px)';
        notification.style.transition = 'all 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }
    
    // ========== FLOATING ELEMENTS ==========
    function initFloatingElements() {
      createFloatingElements();
      setInterval(createFloatingElements, 5000);
    }
    
    function createFloatingElements() {
      const container = document.getElementById('floating-container');
      const elements = ['ðŸ’–', 'ðŸ’—', 'ðŸ’“', 'ðŸ’•', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ·', 'ðŸƒ', 'ðŸŒ¿'];
      
      for (let i = 0; i < 5; i++) {
        const element = document.createElement('div');
        const isPink = Math.random() > 0.3;
        const elem = elements[Math.floor(Math.random() * elements.length)];
        
        element.textContent = elem;
        element.className = `floating-element ${isPink ? 'pink' : ''}`;
        
        element.style.left = `${Math.random() * 100}vw`;
        element.style.fontSize = `${Math.random() * 20 + 16}px`;
        element.style.opacity = Math.random() * 0.4 + 0.1;
        element.style.color = isPink ? getRandomPink() : getRandomGreen();
        element.style.animationDuration = `${Math.random() * 15 + 15}s`;
        
        container.appendChild(element);
        setTimeout(() => element.remove(), 30000);
      }
    }
    
    function getRandomPink() {
      const pinks = ['#B76E79', '#C9A9A6', '#E8B4B8', '#F5C6D6'];
      return pinks[Math.floor(Math.random() * pinks.length)];
    }
    
    function getRandomGreen() {
      const greens = ['#7D8B6F', '#5C6B4F', '#6B7B5E', '#8A9B7C'];
      return greens[Math.floor(Math.random() * greens.length)];
    }
    
    // ========== NAVIGATION ==========
    function initNavigation() {
      // Navigation dots
      document.querySelectorAll('.nav-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          const section = dot.dataset.section;
          navigateToSection(section);
        });
      });
      
      // Section navigation buttons
      document.querySelectorAll('button[data-section]').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.section;
          navigateToSection(section);
        });
      });
      
      // Start button
      document.getElementById('start-btn').addEventListener('click', () => {
        navigateToSection('greeting');
      });
      
      // Mark current section as active initially
      updateNavigationDots();
      showCurrentSection();
    }
    
    function navigateToSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.classList.remove('fade-in');
      });
      
      // Show the selected section
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
        // Add fade-in animation with a slight delay
        setTimeout(() => {
          section.classList.add('fade-in');
        }, 50);
        
        HeartMapState.currentSection = sectionId;
        
        // Mark as completed if editing (but not for Valentine screen in view mode)
        if (sectionId !== 'valentine-question' && !HeartMapState.completedSections.has(sectionId)) {
          HeartMapState.completedSections.add(sectionId);
          HeartMapState.save();
        }
        
        updateNavigationDots();
        updateProgress();
        
        // Scroll to top of page to ensure section is visible
        window.scrollTo(0, 0);
      }
    }
    
    function showCurrentSection() {
      // Show only the current section
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.classList.remove('fade-in');
      });
      
      const currentSection = document.getElementById(HeartMapState.currentSection);
      if (currentSection) {
        currentSection.classList.add('active');
        
        // Add fade-in animation with a slight delay
        setTimeout(() => {
          currentSection.classList.add('fade-in');
        }, 50);
        
        window.scrollTo(0, 0);
      }
    }
    
    function updateNavigationDots() {
      document.querySelectorAll('.nav-dot').forEach(dot => {
        const section = dot.dataset.section;
        dot.classList.remove('active');
        
        if (section === HeartMapState.currentSection) {
          dot.classList.add('active');
        }
        
        if (HeartMapState.completedSections.has(section)) {
          dot.classList.add('completed');
        }
      });
    }
    
    // ========== PROGRESS INDICATOR ==========
    function updateProgress() {
      const totalSections = 6; // Now includes valentine-question
      const completed = HeartMapState.completedSections.size;
      const progress = (completed / totalSections) * 100;
      
      document.getElementById('progress-fill').style.width = `${progress}%`;
    }
    
    // ========== FORM BINDINGS ==========
    function initFormBindings() {
      // Partner name
      const partnerNameInput = document.getElementById('partner-name');
      partnerNameInput.addEventListener('input', (e) => {
        HeartMapState.data.partnerName = e.target.value;
        HeartMapState.save();
        updatePreview();
      });
      
      // Your name
      const yourNameInput = document.getElementById('your-name');
      yourNameInput.addEventListener('input', (e) => {
        HeartMapState.data.yourName = e.target.value;
        HeartMapState.save();
        updatePreview();
      });
      
      // Letter sections
      ['opening', 'body', 'promise', 'closing'].forEach(section => {
        const element = document.getElementById(`letter-${section}`);
        if (element) {
          element.addEventListener('input', (e) => {
            HeartMapState.data.letter[section] = e.target.value;
            HeartMapState.save();
            updatePreview();
          });
        }
      });
      
      // Letter date
      document.getElementById('letter-date').addEventListener('input', (e) => {
        HeartMapState.data.letter.date = e.target.value;
        HeartMapState.save();
      });
    }
    
    // ========== MEMORY TEXT BINDINGS ==========
    function initMemoryTextBindings() {
      // Bind memory textareas to state - FIXED: Ensure all 3 textareas work
      for (let i = 1; i <= 3; i++) {
        const textarea = document.getElementById(`memory-${i}-text`);
        if (textarea) {
          // Load saved text
          if (HeartMapState.data.memories[i-1] && HeartMapState.data.memories[i-1].caption) {
            textarea.value = HeartMapState.data.memories[i-1].caption;
          }
          
          // Add input event listener
          textarea.addEventListener('input', (e) => {
            if (!HeartMapState.data.memories[i-1]) {
              HeartMapState.data.memories[i-1] = {};
            }
            HeartMapState.data.memories[i-1].caption = e.target.value;
            HeartMapState.save();
            updatePreview();
          });
        }
      }
    }
    
    function updateUIFromState() {
      // Partner name
      document.getElementById('partner-name').value = HeartMapState.data.partnerName;
      document.getElementById('letter-partner-name').textContent = HeartMapState.data.partnerName || '[Name]';
      document.getElementById('preview-name').textContent = HeartMapState.data.partnerName || '[Name]';
      
      // Your name
      document.getElementById('your-name').value = HeartMapState.data.yourName;
      document.getElementById('letter-signature').textContent = HeartMapState.data.yourName || '[Your Name]';
      
      // Letter sections
      Object.keys(HeartMapState.data.letter).forEach(section => {
        const element = document.getElementById(`letter-${section}`);
        if (element) element.value = HeartMapState.data.letter[section];
      });
      
      // Memory textareas
      for (let i = 1; i <= 3; i++) {
        const textarea = document.getElementById(`memory-${i}-text`);
        if (textarea && HeartMapState.data.memories[i-1] && HeartMapState.data.memories[i-1].caption) {
          textarea.value = HeartMapState.data.memories[i-1].caption;
        }
      }
      
      updatePreview();
    }
    
    // ========== MEDIA UPLOAD ==========
    function initMediaUpload() {
      const imageUpload = document.getElementById('image-upload');
      const memoryElements = ['memory-1', 'memory-2', 'memory-3'];
      
      memoryElements.forEach((id, index) => {
        const element = document.getElementById(id);
        if (element && HeartMapState.isCreator) {
          element.addEventListener('click', () => {
            currentMemoryIndex = index;
            imageUpload.click();
          });
        }
      });
      
      imageUpload.addEventListener('change', handleImageUpload);
    }
    
    let currentMemoryIndex = 0;
    
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const memoryElement = document.getElementById(`memory-${currentMemoryIndex + 1}`);
        if (memoryElement) {
          memoryElement.innerHTML = `
            <img src="${event.target.result}" 
                 class="w-full h-full object-cover rounded-2xl"
                 alt="Memory ${currentMemoryIndex + 1}">
            <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity duration-300 rounded-2xl flex items-center justify-center">
              <div class="w-12 h-12 rounded-full bg-white/80 flex items-center justify-center">
                <i class="fas fa-edit text-rose-gold"></i>
              </div>
            </div>
          `;
          
          // Save to state
          if (!HeartMapState.data.memories[currentMemoryIndex]) {
            HeartMapState.data.memories[currentMemoryIndex] = {};
          }
          HeartMapState.data.memories[currentMemoryIndex].image = event.target.result;
          HeartMapState.save();
          updatePreview();
          
          // Success animation
          memoryElement.style.animation = 'gentlePulse 1s';
          setTimeout(() => memoryElement.style.animation = '', 1000);
        }
      };
      reader.readAsDataURL(file);
      
      // Reset input
      e.target.value = '';
    }
    
    // ========== MUSIC PLAYER ==========
    function initMusicPlayer() {
      const audio = document.getElementById('audio-player');
      const playBtn = document.getElementById('play-btn');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');
      const uploadBtn = document.getElementById('upload-song-btn');
      const audioUpload = document.getElementById('audio-upload');
      const songTitle = document.getElementById('song-title');
      
      let isPlaying = false;
      let currentSong = HeartMapState.data.song;
      
      // Load saved song
      if (currentSong) {
        audio.src = currentSong.url;
        songTitle.textContent = currentSong.name;
      }
      
      playBtn.addEventListener('click', () => {
        if (!audio.src) {
          alert('Please upload a song first');
          if (HeartMapState.isCreator) {
            uploadBtn.click();
          }
          return;
        }
        
        if (isPlaying) {
          audio.pause();
        } else {
          audio.play().catch(e => {
            console.error('Playback error:', e);
            alert('Unable to play the audio file. Please try another.');
          });
        }
        
        isPlaying = !isPlaying;
        playIcon.classList.toggle('hidden', isPlaying);
        pauseIcon.classList.toggle('hidden', !isPlaying);
      });
      
      if (HeartMapState.isCreator) {
        uploadBtn.addEventListener('click', () => {
          audioUpload.click();
        });
        
        audioUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (!file.type.startsWith('audio/')) {
            alert('Please select an audio file');
            return;
          }
          
          const url = URL.createObjectURL(file);
          currentSong = {
            name: file.name.replace(/\.[^/.]+$/, ""),
            url: url
          };
          
          audio.src = url;
          songTitle.textContent = currentSong.name;
          
          // Save to state
          HeartMapState.data.song = currentSong;
          HeartMapState.save();
          
          // Auto-play
          setTimeout(() => {
            audio.play();
            isPlaying = true;
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
          }, 300);
        });
      }
      
      audio.addEventListener('ended', () => {
        isPlaying = false;
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      });
    }
    
    // ========== PREVIEW UPDATES ==========
    function initPreviewUpdates() {
      updatePreview();
    }
    
    function updatePreview() {
      // Update letter word count
      const letterText = Object.values(HeartMapState.data.letter).join(' ');
      const wordCount = letterText.trim() ? letterText.trim().split(/\s+/).length : 0;
      document.getElementById('preview-letter-length').textContent = wordCount;
      
      // Update photo count
      const photoCount = HeartMapState.data.memories.filter(m => m && m.image).length;
      document.getElementById('preview-photo-count').textContent = photoCount;
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart Map | An Interactive Love Letter</title>
  <!-- Replace CDN Tailwind with direct CSS to avoid production warning -->
  <style>
    /* Tailwind-like utility classes */
    .hidden { display: none !important; }
    .block { display: block !important; }
    .flex { display: flex; }
    .inline-flex { display: inline-flex; }
    .grid { display: grid; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .justify-end { justify-content: flex-end; }
    .flex-col { flex-direction: column; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .gap-8 { gap: 2rem; }
    .gap-16 { gap: 4rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .space-y-6 > * + * { margin-top: 1.5rem; }
    .space-y-8 > * + * { margin-top: 2rem; }
    .space-x-2 > * + * { margin-left: 0.5rem; }
    .space-x-3 > * + * { margin-left: 0.75rem; }
    .space-x-4 > * + * { margin-left: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mb-10 { margin-bottom: 2.5rem; }
    .mb-12 { margin-bottom: 3rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mt-8 { margin-top: 2rem; }
    .mt-12 { margin-top: 3rem; }
    .mr-1 { margin-right: 0.25rem; }
    .mr-2 { margin-right: 0.5rem; }
    .mr-3 { margin-right: 0.75rem; }
    .ml-2 { margin-left: 0.5rem; }
    .ml-3 { margin-left: 0.75rem; }
    .ml-auto { margin-left: auto; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .p-8 { padding: 2rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
    .pt-6 { padding-top: 1.5rem; }
    .pt-8 { padding-top: 2rem; }
    .pb-4 { padding-bottom: 1rem; }
    .pb-8 { padding-bottom: 2rem; }
    .pl-4 { padding-left: 1rem; }
    .pr-4 { padding-right: 1rem; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
    .text-5xl { font-size: 3rem; line-height: 1; }
    .text-6xl { font-size: 3.75rem; line-height: 1; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }
    .italic { font-style: italic; }
    .leading-relaxed { line-height: 1.625; }
    .max-w-xs { max-width: 20rem; }
    .max-w-sm { max-width: 24rem; }
    .max-w-md { max-width: 28rem; }
    .max-w-lg { max-width: 32rem; }
    .max-w-xl { max-width: 36rem; }
    .max-w-2xl { max-width: 42rem; }
    .max-w-3xl { max-width: 48rem; }
    .max-w-4xl { max-width: 56rem; }
    .max-w-5xl { max-width: 64rem; }
    .max-w-6xl { max-width: 72rem; }
    .max-w-full { max-width: 100%; }
    .w-full { width: 100%; }
    .w-3 { width: 0.75rem; }
    .w-4 { width: 1rem; }
    .w-6 { width: 1.5rem; }
    .w-8 { width: 2rem; }
    .w-10 { width: 2.5rem; }
    .w-12 { width: 3rem; }
    .w-14 { width: 3.5rem; }
    .w-16 { width: 4rem; }
    .w-20 { width: 5rem; }
    .w-24 { width: 6rem; }
    .w-32 { width: 8rem; }
    .w-48 { width: 12rem; }
    .h-3 { height: 0.75rem; }
    .h-4 { height: 1rem; }
    .h-6 { height: 1.5rem; }
    .h-8 { height: 2rem; }
    .h-10 { height: 2.5rem; }
    .h-12 { height: 3rem; }
    .h-14 { height: 3.5rem; }
    .h-16 { height: 4rem; }
    .h-20 { height: 5rem; }
    .h-24 { height: 6rem; }
    .h-32 { height: 8rem; }
    .h-48 { height: 12rem; }
    .aspect-square { aspect-ratio: 1 / 1; }
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-2xl { border-radius: 1rem; }
    .rounded-3xl { border-radius: 1.5rem; }
    .rounded-full { border-radius: 9999px; }
    .border { border-width: 1px; }
    .border-2 { border-width: 2px; }
    .border-t { border-top-width: 1px; }
    .border-b { border-bottom-width: 1px; }
    .border-dashed { border-style: dashed; }
    .border-blush { border-color: var(--blush); }
    .border-rose-gold { border-color: var(--rose-gold); }
    .border-rose-gold\/30 { border-color: rgba(183, 110, 121, 0.3); }
    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .bg-white { background-color: white; }
    .bg-blush { background-color: var(--blush); }
    .bg-blush\/20 { background-color: rgba(232, 221, 212, 0.2); }
    .bg-rose-gold\/10 { background-color: rgba(183, 110, 121, 0.1); }
    .bg-rose-gold\/5 { background-color: rgba(183, 110, 121, 0.05); }
    .bg-sage\/10 { background-color: rgba(125, 139, 111, 0.1); }
    .bg-sage\/30 { background-color: rgba(125, 139, 111, 0.3); }
    .bg-pale-pink\/40 { background-color: rgba(245, 198, 214, 0.4); }
    .from-blush\/20 { --tw-gradient-from: rgba(232, 221, 212, 0.2); }
    .to-pale-pink\/20 { --tw-gradient-to: rgba(245, 198, 214, 0.2); }
    .hover\:bg-blush\/20:hover { background-color: rgba(232, 221, 212, 0.2); }
    .hover\:scale-\[1\.02\]:hover { transform: scale(1.02); }
    .hover\:scale-105:hover { transform: scale(1.05); }
    .hover\:border-rose-gold\/60:hover { border-color: rgba(183, 110, 121, 0.6); }
    .hover\:text-rose-gold:hover { color: var(--rose-gold); }
    .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
    .transition-all { transition-property: all; }
    .transition-colors { transition-property: background-color, border-color, color, fill, stroke; }
    .transition-transform { transition-property: transform; }
    .transition-opacity { transition-property: opacity; }
    .duration-300 { transition-duration: 300ms; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .fixed { position: fixed; }
    .sticky { position: sticky; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    .inset-4 { top: 1rem; right: 1rem; bottom: 1rem; left: 1rem; }
    .inset-y-0 { top: 0; bottom: 0; }
    .top-0 { top: 0; }
    .top-6 { top: 1.5rem; }
    .top-24 { top: 6rem; }
    .right-0 { right: 0; }
    .right-6 { right: 1.5rem; }
    .bottom-0 { bottom: 0; }
    .left-0 { left: 0; }
    .z-10 { z-index: 10; }
    .z-50 { z-index: 50; }
    .z-100 { z-index: 100; }
    .z-1000 { z-index: 1000; }
    .z-2000 { z-index: 2000; }
    .z-2001 { z-index: 2001; }
    .z-9999 { z-index: 9999; }
    .overflow-hidden { overflow: hidden; }
    .overflow-x-hidden { overflow-x: hidden; }
    .overflow-y-auto { overflow-y: auto; }
    .pointer-events-none { pointer-events: none; }
    .pointer-events-auto { pointer-events: auto; }
    .cursor-pointer { cursor: pointer; }
    .cursor-default { cursor: default; }
    .resize-none { resize: none; }
    .resize-vertical { resize: vertical; }
    .object-cover { object-fit: cover; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    
    @media (max-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .md\:text-6xl { font-size: 3.75rem; line-height: 1; }
    }
    
    @media (max-width: 640px) {
      .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    }
  </style>
  
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Dancing+Script:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cream: #FDF8F3;
      --sage: #7D8B6F;
      --deep-sage: #5C6B4F;
      --blush: #E8DDD4;
      --moss: #4A5D3E;
      --rose-gold: #B76E79;
      --dusty-rose: #C9A9A6;
      --soft-pink: #E8B4B8;
      --pale-pink: #F5C6D6;
      --deep-pink: #9E4A5A;
    }
    
    body {
      background: var(--cream);
      font-family: 'Inter', sans-serif;
      color: #2C3E2F;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }
    
    .romantic-title {
      font-family: 'Cormorant Garamond', serif;
    }
    
    .script-font {
      font-family: 'Dancing Script', cursive;
    }
    
    .elegant-font {
      font-family: 'Playfair Display', serif;
    }
    
    /* ========== ENHANCED ANIMATIONS ========== */
    
    /* 1. Subtle background pulse */
    @keyframes backgroundPulse {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(253, 248, 243, 0.8) 0%, 
        rgba(232, 221, 212, 0.3) 25%, 
        rgba(245, 198, 214, 0.2) 50%,
        rgba(232, 221, 212, 0.3) 75%,
        rgba(253, 248, 243, 0.8) 100%);
      background-size: 400% 400%;
      animation: backgroundPulse 20s ease infinite;
      pointer-events: none;
      z-index: -1;
    }
    
    /* 2. Twinkling stars effect */
    @keyframes twinkle {
      0%, 100% {
        opacity: 0.1;
        transform: scale(1);
      }
      50% {
        opacity: 0.3;
        transform: scale(1.1);
      }
    }
    
    .twinkle {
      position: fixed;
      background: white;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      animation: twinkle 3s infinite;
    }
    
    /* 3. Floating leaves animation */
    @keyframes floatLeaf {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      90% {
        opacity: 0.7;
      }
      100% {
        transform: translateY(-100px) rotate(720deg) translateX(50px);
        opacity: 0;
      }
    }
    
    .floating-leaf {
      position: fixed;
      pointer-events: none;
      z-index: 1;
      font-size: 24px;
      opacity: 0.3;
      animation: floatLeaf linear forwards;
    }
    
    /* 4. Gentle sway animation for cards */
    @keyframes gentleSway {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-3px) rotate(0.5deg);
      }
      75% {
        transform: translateY(2px) rotate(-0.5deg);
      }
    }
    
    .gentle-sway {
      animation: gentleSway 8s ease-in-out infinite;
    }
    
    /* 5. Typewriter effect for text */
    @keyframes typewriter {
      from {
        width: 0;
      }
      to {
        width: 100%;
      }
    }
    
    .typewriter {
      overflow: hidden;
      white-space: nowrap;
      animation: typewriter 3s steps(40, end);
    }
    
    /* 6. Button shimmer effect */
    @keyframes shimmer {
      0% {
        background-position: -200px 0;
      }
      100% {
        background-position: calc(200px + 100%) 0;
      }
    }
    
    .shimmer-btn {
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to right,
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 100%
      );
      transform: rotate(30deg);
      animation: shimmer 3s infinite;
    }
    
    /* 7. Glow effect for active elements */
    @keyframes glowPulse {
      0%, 100% {
        box-shadow: 0 0 5px rgba(183, 110, 121, 0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(183, 110, 121, 0.5);
      }
    }
    
    .glow-pulse {
      animation: glowPulse 2s infinite;
    }
    
    /* 8. Page transition animations */
    @keyframes slideInRight {
      from {
        transform: translateX(30px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideInLeft {
      from {
        transform: translateX(-30px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideInUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .slide-in-right {
      animation: slideInRight 0.6s ease-out forwards;
    }
    
    .slide-in-left {
      animation: slideInLeft 0.6s ease-out forwards;
    }
    
    .slide-in-up {
      animation: slideInUp 0.6s ease-out forwards;
    }
    
    /* 9. Bounce on hover */
    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    
    .bounce-on-hover:hover {
      animation: bounce 0.5s;
    }
    
    /* ========== ANIMATED EMOJIS ========== */
    
    /* Smirking emoji animation */
    @keyframes smirk {
      0%, 100% {
        transform: rotate(0deg) scale(1);
      }
      25% {
        transform: rotate(-5deg) scale(1.1);
      }
      50% {
        transform: rotate(5deg) scale(1.05);
      }
      75% {
        transform: rotate(-3deg) scale(1.08);
      }
    }
    
    .animated-smirk {
      display: inline-block;
      animation: smirk 3s infinite;
      font-size: 2rem;
      cursor: pointer;
    }
    
    /* Winking emoji animation */
    @keyframes wink {
      0%, 100% {
        transform: scaleY(1);
      }
      50% {
        transform: scaleY(0.1);
      }
    }
    
    .animated-wink {
      display: inline-block;
      position: relative;
      animation: wink 2s infinite;
      font-size: 2rem;
      cursor: pointer;
    }
    
    /* Blushing emoji animation */
    @keyframes blush {
      0%, 100% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2) hue-rotate(10deg);
      }
    }
    
    .animated-blush {
      display: inline-block;
      animation: blush 4s infinite;
      font-size: 2rem;
      cursor: pointer;
    }
    
    /* Heart eyes animation */
    @keyframes heartEyes {
      0%, 100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.2);
      }
      50% {
        transform: scale(1.1);
      }
      75% {
        transform: scale(1.15);
      }
    }
    
    .animated-heart-eyes {
      display: inline-block;
      animation: heartEyes 2s infinite;
      font-size: 2rem;
      cursor: pointer;
    }
    
    /* Floating emoji particles */
    @keyframes floatEmoji {
      0% {
        transform: translateY(100vh) rotate(0deg) scale(0.5);
        opacity: 0;
      }
      10% {
        opacity: 0.8;
      }
      90% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(-100px) rotate(360deg) scale(1);
        opacity: 0;
      }
    }
    
    .emoji-particle {
      position: fixed;
      pointer-events: none;
      z-index: 5;
      font-size: 24px;
      animation: floatEmoji linear forwards;
      user-select: none;
    }
    
    /* Emoji rain effect */
    @keyframes emojiRain {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    .emoji-rain {
      position: fixed;
      pointer-events: none;
      z-index: 2;
      animation: emojiRain linear forwards;
    }
    
    /* Emoji pulse effect */
    @keyframes emojiPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.3);
      }
    }
    
    .emoji-pulse {
      animation: emojiPulse 1.5s infinite;
      display: inline-block;
    }
    
    /* ========== COMPACT MEMORY LAYOUT ========== */
    
    /* Memory grid - more compact layout */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      max-height: 60vh;
      overflow: hidden;
      padding: 1rem;
    }
    
    .memory-item {
      aspect-ratio: 1;
      max-height: 250px;
      position: relative;
    }
    
    .memory-image-container {
      height: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    /* Make sure textareas don't cause overflow */
    .memory-textarea-container {
      margin-top: 0.75rem;
      max-height: 100px;
    }
    
    /* Media queries for smaller screens */
    @media (max-width: 768px) {
      .memory-grid {
        grid-template-columns: repeat(2, 1fr);
        max-height: 70vh;
        gap: 1rem;
      }
      
      .memory-item {
        max-height: 200px;
      }
    }
    
    @media (max-width: 480px) {
      .memory-grid {
        grid-template-columns: 1fr;
        max-height: 80vh;
      }
      
      .memory-item {
        max-height: 180px;
      }
    }
    
    /* NO button styles */
    .no-btn {
      padding: 12px 24px !important;
      border-radius: 50px !important;
      font-size: 16px !important;
      background: var(--cream) !important;
      color: var(--sage) !important;
      border: 2px solid var(--sage) !important;
      box-shadow: 0 4px 12px rgba(92, 107, 79, 0.15) !important;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      max-width: 180px;
      text-align: center;
      line-height: 1.4;
      position: absolute !important;
      z-index: 100;
    }
    
    .no-btn:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 6px 20px rgba(92, 107, 79, 0.25) !important;
      background: var(--blush) !important;
      border-color: var(--deep-sage) !important;
    }
    
    .no-btn i {
      font-size: 14px;
      margin-right: 6px;
    }
    
    /* Floating animations */
    @keyframes floatUp {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      90% {
        opacity: 0.7;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }
    
    @keyframes floatUpPink {
      0% {
        transform: translateY(100vh) rotate(180deg) translateX(-30px);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.6;
      }
      100% {
        transform: translateY(-100px) rotate(540deg) translateX(30px);
        opacity: 0;
      }
    }
    
    .floating-element {
      position: fixed;
      pointer-events: none;
      z-index: 1;
      animation: floatUp linear forwards;
    }
    
    .floating-element.pink {
      animation: floatUpPink linear forwards;
    }
    
    /* Heart animations */
    @keyframes gentlePulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.9;
      }
      50% {
        transform: scale(1.08);
        opacity: 1;
      }
    }
    
    @keyframes heartbeat {
      0% {
        transform: scale(1);
      }
      14% {
        transform: scale(1.1);
      }
      28% {
        transform: scale(1);
      }
      42% {
        transform: scale(1.1);
      }
      70% {
        transform: scale(1);
      }
    }
    
    .gentle-pulse {
      animation: gentlePulse 4s ease-in-out infinite;
    }
    
    .heartbeat {
      animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    /* Page transitions */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        visibility: hidden;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }
    
    .fade-out {
      animation: fadeOut 0.8s ease-out forwards;
    }
    
    /* Progress indicator */
    .progress-track {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(232, 221, 212, 0.3);
      z-index: 1000;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--sage), var(--rose-gold));
      width: 0%;
      transition: width 0.6s ease;
      border-radius: 0 3px 3px 0;
    }
    
    /* Navigation */
    .nav-dots {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .nav-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(125, 139, 111, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .nav-dot:hover {
      background: var(--rose-gold);
      transform: scale(1.4);
    }
    
    .nav-dot.active {
      background: var(--rose-gold);
      transform: scale(1.4);
      box-shadow: 0 0 0 2px rgba(183, 110, 121, 0.1);
    }
    
    .nav-dot.completed:after {
      content: '‚úì';
      position: absolute;
      top: -2px;
      left: 1px;
      font-size: 8px;
      color: white;
    }
    
    /* Cards and containers */
    .elegant-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 
        0 10px 40px rgba(92, 107, 79, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(232, 221, 212, 0.6);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 
        0 15px 35px rgba(183, 110, 121, 0.08),
        0 5px 15px rgba(0, 0, 0, 0.03);
    }
    
    /* Buttons */
    .primary-btn {
      background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 50px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .primary-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(183, 110, 121, 0.25);
      background: linear-gradient(135deg, var(--deep-pink), var(--rose-gold));
    }
    
    .primary-btn:active {
      transform: translateY(-1px);
    }
    
    .secondary-btn {
      background: transparent;
      color: var(--rose-gold);
      border: 2px solid var(--rose-gold);
      padding: 12px 28px;
      border-radius: 50px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .secondary-btn:hover {
      background: rgba(183, 110, 121, 0.08);
      transform: translateY(-2px);
    }
    
    /* Form elements */
    .elegant-input {
      background: transparent;
      border: none;
      border-bottom: 2px solid rgba(183, 110, 121, 0.2);
      padding: 12px 0;
      font-size: 20px;
      font-family: 'Dancing Script', cursive;
      color: var(--deep-sage);
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .elegant-input:focus {
      outline: none;
      border-bottom-color: var(--rose-gold);
      background: rgba(183, 110, 121, 0.03);
      padding-left: 12px;
      padding-right: 12px;
    }
    
    .elegant-input::placeholder {
      color: rgba(183, 110, 121, 0.4);
      font-style: italic;
    }
    
    /* Typography */
    h1, h2, h3, h4 {
      color: #2C3E2F;
      font-weight: 500;
      line-height: 1.2;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, var(--sage), var(--rose-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtle-text {
      color: #5A6B5C;
      line-height: 1.7;
    }
    
    /* Memory textarea styles */
    .memory-description {
      display: block !important;
      width: 100%;
      min-height: 60px;
      max-height: 80px;
      padding: 10px;
      border: 1px solid rgba(183, 110, 121, 0.3);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: var(--deep-sage);
      background: rgba(255, 255, 255, 0.9);
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    .memory-description:focus {
      outline: none;
      border-color: var(--rose-gold);
      box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
    }
    
    /* ========== REST OF YOUR EXISTING STYLES ========== */
    
    /* Completion states */
    .completion-checkmark {
      width: 24px;
      height: 24px;
      background: var(--sage);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    
    /* View-only mode */
    .view-only .editable-content,
    .view-only input,
    .view-only textarea {
      pointer-events: none;
      background: transparent;
      border: none;
      user-select: text;
      -webkit-user-select: text;
    }
    
    .view-only .elegant-input {
      border-bottom: 1px solid rgba(183, 110, 121, 0.1);
    }
    
    .view-only .primary-btn,
    .view-only .secondary-btn {
      cursor: default;
    }
    
    .view-only .primary-btn:hover,
    .view-only .secondary-btn:hover {
      transform: none;
      box-shadow: none;
    }
    
    .creator-mode .primary-btn,
    .creator-mode .secondary-btn {
      pointer-events: auto;
    }
    
    /* Hide creator-only elements in partner view */
    .view-only .creator-only,
    .view-only .editable-field,
    .view-only [class*="STEP"],
    .view-only .completion-checkmark {
      display: none !important;
    }
    
    /* Show partner-only elements */
    .view-only .partner-only {
      display: block !important;
    }
    
    .creator-only {
      display: block;
    }
    
    .partner-only {
      display: none;
    }
    
    /* Adjust sections for partner view */
    .view-only .section > div {
      width: 100%;
      max-width: 800px !important;
    }
    
    /* Preview mode */
    .preview-mode .creator-only {
      display: none !important;
    }
    
    .preview-mode .partner-only {
      display: block !important;
    }
    
    .preview-mode .editable-field,
    .preview-mode [class*="STEP"],
    .preview-mode .completion-checkmark {
      display: none !important;
    }
    
    .preview-mode .section > div {
      width: 100%;
      max-width: 800px !important;
    }
    
    /* Section visibility control */
    .section {
      display: none;
      min-height: 100vh;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .section.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Valentine screen specific styles */
    #valentine-question .elegant-card {
      position: relative;
      overflow: hidden;
    }
    
    #valentine-hearts-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    
    /* Celebration animation */
    @keyframes celebrate {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(1.5);
        opacity: 0;
      }
    }
    
    /* Show/hide animation for secret message */
    .show {
      display: block !important;
    }
    
    /* Share link success animation */
    @keyframes successPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(125, 139, 111, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(125, 139, 111, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(125, 139, 111, 0);
      }
    }
    
    .success-pulse {
      animation: successPulse 1.5s ease-out;
    }
    
    /* Preview container */
    .preview-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--cream);
      z-index: 2000;
      overflow-y: auto;
      display: none;
    }
    
    .preview-container.active {
      display: block;
    }
    
    .preview-header {
      position: sticky;
      top: 0;
      background: var(--cream);
      padding: 1rem;
      border-bottom: 1px solid rgba(183, 110, 121, 0.1);
      z-index: 2001;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Fix memory text display in partner view */
    .memory-display {
      position: relative;
      z-index: 1;
    }
    
    /* Partner view fix */
    .view-only .memory-description {
      display: none !important;
    }
    
    .view-only .partner-only .text-center.subtle-text.p-3 {
      display: block !important;
      min-height: 60px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      border: 1px solid rgba(183, 110, 121, 0.1);
      margin-top: 1rem;
    }
    
    /* Notification styles */
    .heartmap-notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 16px;
      border-left: 4px solid var(--rose-gold);
      z-index: 9999;
      max-width: 320px;
      animation: fadeIn 0.3s ease-out;
      font-family: 'Inter', sans-serif;
    }
    
    /* Memory container fix - textarea should not be part of clickable area */
    .memory-image-container:hover {
      transform: scale(1.02);
      border-color: rgba(183, 110, 121, 0.6) !important;
    }
    
    .memory-textarea-container {
      margin-top: 1rem;
      pointer-events: auto !important;
    }
    
    /* Settings panel for NO button phrases */
    .settings-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: white;
      box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      transition: right 0.3s ease;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .settings-panel.active {
      right: 0;
    }
    
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9999;
      display: none;
    }
    
    .settings-overlay.active {
      display: block;
    }
    
    /* Image compression indicator */
    .compression-info {
      font-size: 12px;
      color: var(--sage);
      margin-top: 0.5rem;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .nav-dots {
        right: 16px;
      }
      
      .elegant-card {
        padding: 1.5rem;
        margin: 0 1rem;
      }
      
      h1 {
        font-size: 2.5rem;
      }
      
      .primary-btn, .secondary-btn {
        padding: 12px 24px;
        font-size: 15px;
      }
      
      .section.active {
        padding: 10px;
      }
      
      .no-btn {
        padding: 10px 20px !important;
        font-size: 14px !important;
        max-width: 160px;
      }
      
      .heartmap-notification {
        top: 16px;
        right: 16px;
        left: 16px;
        max-width: none;
      }
      
      .settings-panel {
        width: 100%;
        right: -100%;
      }
    }
    
    /* Loading states */
    .loading-dots {
      display: inline-block;
    }
    
    .loading-dots span {
      animation: blink 1.4s infinite both;
      display: inline-block;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    
    /* Remove smooth scrolling */
    html {
      scroll-behavior: auto;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(232, 221, 212, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(183, 110, 121, 0.4);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(183, 110, 121, 0.6);
    }
    
    /* Valentine screen fix */
    #valentine-question.section.active {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px !important;
      min-height: 100vh !important;
      width: 100% !important;
    }
  </style>
</head>
<body>
  <!-- Animated Emoji Container -->
  <div id="emoji-container"></div>
  
  <!-- NO Button Container (Will be created dynamically) -->
  <div id="no-button-container"></div>
  
  <!-- Floating Elements -->
  <div id="floating-container"></div>
  
  <!-- Progress Indicator -->
  <div class="progress-track">
    <div id="progress-fill" class="progress-fill"></div>
  </div>
  
  <!-- Settings Panel for NO button phrases -->
  <div id="settings-overlay" class="settings-overlay"></div>
  <div id="settings-panel" class="settings-panel">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl elegant-font">NO Button Settings</h3>
      <button id="close-settings" class="secondary-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <p class="subtle-text mb-4">Edit what appears when your partner clicks "NO" on the Valentine question:</p>
    
    <div id="no-phrases-list" class="space-y-3 mb-6"></div>
    
    <div class="flex gap-3">
      <button id="add-phrase" class="secondary-btn flex-1">
        <i class="fas fa-plus mr-2"></i>Add New
      </button>
      <button id="reset-phrases" class="secondary-btn flex-1">
        <i class="fas fa-redo mr-2"></i>Reset to Default
      </button>
    </div>
    
    <div class="mt-6 p-4 rounded-lg bg-rose-gold/10">
      <p class="text-sm subtle-text">
        <i class="fas fa-lightbulb mr-2"></i>
        These phrases will appear randomly when your partner clicks "NO" on the Valentine question screen.
      </p>
    </div>
  </div>
  
  <!-- Navigation Dots -->
  <div class="nav-dots">
    <div class="nav-dot" data-section="valentine-question"></div>
    <div class="nav-dot active completed" data-section="welcome"></div>
    <div class="nav-dot" data-section="greeting"></div>
    <div class="nav-dot" data-section="letter"></div>
    <div class="nav-dot" data-section="memories"></div>
    <div class="nav-dot" data-section="final"></div>
  </div>
  
  <!-- Preview Container -->
  <div id="preview-container" class="preview-container">
    <div class="preview-header">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
          <i class="fas fa-eye text-white"></i>
        </div>
        <h3 class="text-xl elegant-font">Preview Mode</h3>
      </div>
      <button id="close-preview" class="secondary-btn">
        <i class="fas fa-times mr-2"></i>Close Preview
      </button>
    </div>
    <div id="preview-content" class="p-4"></div>
  </div>
  
  <!-- Main Content -->
  <main>
    <!-- Valentine Question Screen (Shown to partner only) -->
    <section id="valentine-question" class="section">
      <div class="text-center max-w-3xl w-full fade-in">
        <div class="elegant-card mx-auto">
          <!-- Animated Hearts Background -->
          <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div id="valentine-hearts-container"></div>
          </div>
          
          <div class="relative z-10">
            <!-- Header -->
            <div class="mb-8">
              <div class="inline-flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-xl"></i>
                </div>
                <h1 class="text-4xl elegant-font">Heart Map</h1>
              </div>
              <p class="subtle-text mb-2">A Special Question For You</p>
            </div>
            
            <!-- Main Question -->
            <div class="mb-12">
              <div class="w-48 h-48 mx-auto mb-8 relative">
                <div class="absolute inset-0 rounded-full animate-pulse" style="background: linear-gradient(135deg, rgba(183, 110, 121, 0.1), rgba(158, 74, 90, 0.1));"></div>
                <div class="absolute inset-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-6xl heartbeat"></i>
                </div>
              </div>
              
              <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
                Will You Be My Valentine?
              </h2>
              
              <p class="text-xl subtle-text mb-6 max-w-2xl mx-auto">
                My heart has mapped its course, and it leads straight to you. 
                Will you be mine on this journey of love?
              </p>
              
              <!-- Partner's Name Display -->
              <div class="inline-block px-6 py-3 rounded-full bg-blush/30 mb-8">
                <span class="text-2xl script-font gradient-text" id="valentine-partner-name">My Dearest</span>
              </div>
            </div>
            
            <!-- Yes Button Container -->
            <div class="space-y-6 max-w-md mx-auto">
              <!-- Buttons Container -->
              <div class="flex flex-col gap-4" id="buttons-container">
                <!-- Yes Button -->
                <button id="yes-valentine-btn" class="primary-btn w-full transform hover:scale-105 transition-transform duration-300 shimmer-btn bounce-on-hover">
                  <span class="flex items-center justify-center gap-3 text-xl">
                    <i class="fas fa-heart"></i>
                    Yes, With All My Heart!
                    <i class="fas fa-heart"></i>
                  </span>
                </button>
                
                <!-- Initial NO Button (beside YES) -->
                <div id="initial-no-button-container" class="w-full flex justify-center">
                  <button id="initial-no-btn" class="no-btn w-full max-w-sm">
                    <i class="fas fa-times"></i> No Never!
                  </button>
                </div>
              </div>
              
              <!-- Secret Message (appears after clicking No a few times) -->
              <div id="secret-message" class="hidden mt-4 p-4 rounded-lg bg-rose-gold/10 border border-rose-gold/20">
                <p class="subtle-text">
                  <span class="animated-smirk">üòè</span>
                  <span class="ml-2">I know you're just being shy! The "Yes" button is waiting patiently...</span>
                </p>
              </div>
              
              <p class="text-sm subtle-text mt-6">
                <i class="fas fa-info-circle mr-1"></i>
                Keep clicking the NO button to see it move around!
              </p>
            </div>
            
            <!-- Decorative Elements -->
            <div class="mt-12 flex items-center justify-center gap-6">
              <div class="w-6 h-6 rounded-full bg-rose-gold/30 animated-smirk">üòè</div>
              <div class="w-4 h-4 rounded-full bg-sage/30 animated-wink">üòâ</div>
              <div class="w-8 h-8 rounded-full bg-pale-pink/40 animated-blush">üòä</div>
              <div class="w-4 h-4 rounded-full bg-sage/30 animated-heart-eyes">üòç</div>
              <div class="w-6 h-6 rounded-full bg-rose-gold/30 emoji-pulse">üíñ</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Welcome Screen -->
    <section id="welcome" class="section active gentle-sway">
      <div class="text-center max-w-3xl w-full fade-in">
        <div class="elegant-card mx-auto">
          <!-- Logo/Title -->
          <div class="mb-8">
            <div class="inline-flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                <i class="fas fa-heart text-white text-xl"></i>
              </div>
              <h1 class="text-4xl elegant-font">Heart Map</h1>
            </div>
            <p class="subtle-text mb-2">An Interactive Love Letter</p>
          </div>
          
          <!-- Main Heart Visual -->
          <div class="mb-10">
            <div class="relative inline-block">
              <div class="w-48 h-48 mx-auto rounded-full flex items-center justify-center gentle-pulse" style="background: linear-gradient(135deg, rgba(125, 139, 111, 0.1), rgba(183, 110, 121, 0.1));">
                <svg class="w-32 h-32" fill="url(#heartGradient)" viewBox="0 0 24 24">
                  <defs>
                    <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#7D8B6F;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#B76E79;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <div class="absolute -top-2 -right-2 w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-lg">
                <i class="fas fa-map-marker-alt text-rose-gold"></i>
              </div>
            </div>
          </div>
          
          <!-- Creator Mode Content -->
          <div id="creator-mode-content" class="creator-only">
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
              Map Your Heart
            </h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              Create a personalized, interactive love story for your special someone. 
              Every click adds to your unique journey together.
            </p>
            
            <!-- Start Button -->
            <div class="space-y-4">
              <button id="start-btn" class="primary-btn w-full max-w-sm mx-auto shimmer-btn bounce-on-hover">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-play"></i>
                  Begin Your Heart Map
                </span>
              </button>
              
              <p class="text-sm subtle-text">
                <i class="fas fa-info-circle mr-1"></i>
                Follow the steps to create your love letter
              </p>
            </div>
            
            <!-- Settings Button (for NO button phrases) -->
            <div class="mt-8 pt-6 border-t border-blush">
              <button id="open-settings" class="secondary-btn bounce-on-hover">
                <i class="fas fa-cog mr-2"></i>
                Edit Valentine NO Button Phrases
              </button>
              <p class="text-xs subtle-text mt-2">
                Customize what appears when your partner clicks "NO" on the Valentine question
              </p>
            </div>
          </div>
          
          <!-- Partner Mode Content -->
          <div id="partner-mode-content" class="partner-only">
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">
              Welcome to My Heart Map
            </h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              You've received a special love letter!
              Created just for you by your devotee.
              Every click reveals more of my heartfelt confession.
            </p>
            
            <div class="space-y-4">
              <button id="view-letter-btn" class="primary-btn w-full max-w-sm mx-auto shimmer-btn bounce-on-hover">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-heart"></i>
                  Open Your Love Letter
                </span>
              </button>
              
              <p class="text-sm subtle-text">
                <i class="fas fa-info-circle mr-1"></i>
                Will you explore this heartfelt message? I created it just for you, to show you what my words often struggle to say.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Greeting Section -->
    <section id="greeting" class="section gentle-sway">
      <div class="max-w-2xl w-full fade-in">
        <div class="elegant-card">
          <!-- Partner View Header -->
          <div class="mb-8 text-center partner-only">
            <h2 class="text-4xl elegant-font mb-4">For My Dearest <span id="partner-name-display">[Name]</span></h2>
            <p class="subtle-text">A heartfelt message just for you</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="creator-only">
            <div class="mb-8 text-center">
              <div class="inline-flex items-center gap-2 mb-4">
                <span class="completion-checkmark">1</span>
                <span class="text-sm font-medium text-sage">STEP 1 OF 4</span>
              </div>
              <h2 class="text-4xl elegant-font mb-4">To My Dearest</h2>
              <p class="subtle-text">Start by personalizing this letter with your loved one's name</p>
            </div>
            
            <div class="space-y-8">
              <div>
                <label class="block text-sm font-medium mb-2 subtle-text">Their Name</label>
                <input 
                  type="text" 
                  id="partner-name" 
                  class="elegant-input text-3xl script-font text-center editable-field"
                  placeholder="Enter their name..."
                  maxlength="30"
                >
                <p class="text-xs subtle-text mt-2 text-center">This will appear throughout your love letter</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2 subtle-text">Your Name</label>
                <input 
                  type="text" 
                  id="your-name" 
                  class="elegant-input text-2xl script-font text-center editable-field"
                  placeholder="Your name..."
                  maxlength="30"
                >
              </div>
              
              <div class="pt-6 border-t border-blush">
                <div class="flex items-center justify-between">
                  <button data-section="welcome" class="secondary-btn bounce-on-hover">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                  </button>
                  
                  <button data-section="letter" class="primary-btn shimmer-btn bounce-on-hover" id="next-to-letter">
                    Continue to Letter
                    <i class="fas fa-arrow-right ml-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Partner View Content -->
          <div class="partner-only">
            <div class="text-center mb-8">
              <h3 class="text-3xl script-font gradient-text" id="letter-salutation-display">My Dearest <span id="partner-name-display-text">[Name]</span></h3>
            </div>
            <div class="text-center mt-12">
              <button data-section="letter" class="primary-btn shimmer-btn bounce-on-hover">
                Read Your Love Letter
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Letter Section -->
    <section id="letter" class="section gentle-sway">
      <div class="max-w-3xl w-full fade-in">
        <div class="glass-card">
          <!-- Partner View Header -->
          <div class="mb-8 text-center partner-only">
            <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
            <p class="subtle-text mb-6">A message from the heart</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="mb-8 text-center creator-only">
            <div class="inline-flex items-center gap-2 mb-4">
              <span class="completion-checkmark">2</span>
              <span class="text-sm font-medium text-sage">STEP 2 OF 4</span>
            </div>
            <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
            <p class="subtle-text mb-6">Write from your heart. These words will be treasured forever.</p>
          </div>
          
          <!-- Letter Content -->
          <div class="space-y-6">
            <!-- Date -->
            <div class="text-right">
              <input 
                type="text" 
                id="letter-date" 
                class="elegant-input text-right max-w-xs ml-auto editable-field creator-only"
                placeholder="Today's date..."
                value="February 14, 2026"
              >
              <p id="letter-date-display" class="partner-only subtle-text text-lg"></p>
            </div>
            
            <!-- Salutation -->
            <div class="text-center mb-8">
              <h3 class="text-3xl script-font gradient-text" id="letter-salutation">My Dearest <span id="letter-partner-name">[Name]</span></h3>
            </div>
            
            <!-- Letter Body -->
            <div class="space-y-8">
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">Opening</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">My Dearest</p>
                </div>
                <textarea 
                  id="letter-opening"
                  class="w-full elegant-input min-h-[100px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="My love, the moment I met you..."
                  rows="3"
                ></textarea>
                <div id="letter-opening-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">What I Love About You</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">What I Love About You</p>
                </div>
                <textarea 
                  id="letter-body"
                  class="w-full elegant-input min-h-[150px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="I love the way you... Your smile reminds me of... The thing I cherish most is..."
                  rows="5"
                ></textarea>
                <div id="letter-body-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">My Promise to You</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">My Promise to You</p>
                </div>
                <textarea 
                  id="letter-promise"
                  class="w-full elegant-input min-h-[100px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="I promise to always... Together, we will..."
                  rows="3"
                ></textarea>
                <div id="letter-promise-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-3 subtle-text creator-only">Closing</label>
                <div class="partner-only">
                  <p class="text-lg font-medium mb-2">With All My Love</p>
                </div>
                <textarea 
                  id="letter-closing"
                  class="w-full elegant-input min-h-[80px] p-4 rounded-lg border border-blush resize-none editable-field creator-only"
                  placeholder="With all my love and admiration..."
                  rows="2"
                ></textarea>
                <div id="letter-closing-display" class="partner-only text-lg subtle-text leading-relaxed"></div>
              </div>
            </div>
            
            <!-- Signature -->
            <div class="text-center mt-12 pt-8 border-t border-blush">
              <div class="mb-4">
                <span class="text-3xl script-font gradient-text" id="letter-signature">[Your Name]</span>
                <span id="letter-signature-display" class="partner-only text-3xl script-font gradient-text"></span>
              </div>
              <p class="text-sm subtle-text italic">Forever yours</p>
            </div>
            
            <!-- Navigation -->
            <div class="flex items-center justify-between pt-8">
              <!-- Creator Navigation -->
              <button data-section="greeting" class="secondary-btn creator-only bounce-on-hover">
                <i class="fas fa-arrow-left mr-2"></i>Back
              </button>
              
              <button data-section="memories" class="primary-btn creator-only shimmer-btn bounce-on-hover">
                Add Memories
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
              
              <!-- Partner Navigation -->
              <button data-section="greeting" class="secondary-btn partner-only bounce-on-hover">
                <i class="fas fa-arrow-left mr-2"></i>Previous
              </button>
              
              <button data-section="memories" class="primary-btn partner-only shimmer-btn bounce-on-hover">
                View Memories
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Memories Section - COMPACT FIXED STRUCTURE -->
    <section id="memories" class="section">
      <div class="max-w-6xl w-full fade-in">
        <div class="glass-card">
          <!-- Partner View Header -->
          <div class="mb-6 text-center partner-only">
            <h2 class="text-3xl elegant-font mb-3">Our Treasured Moments</h2>
            <p class="subtle-text mb-4">Special memories we've shared together</p>
          </div>
          
          <!-- Creator View Header -->
          <div class="creator-only">
            <div class="mb-6 text-center">
              <div class="inline-flex items-center gap-2 mb-3">
                <span class="completion-checkmark">3</span>
                <span class="text-sm font-medium text-sage">STEP 3 OF 4</span>
              </div>
              <h2 class="text-3xl elegant-font mb-3">Our Treasured Moments</h2>
              <p class="subtle-text mb-4">Add photos and memories that tell our story</p>
            </div>
          </div>
          
          <!-- COMPACT Memory Grid -->
          <div class="memory-grid mb-8">
            <!-- Memory 1 -->
            <div class="memory-item">
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only" id="memory-1">
                <div class="text-center p-4">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                    <i class="fas fa-camera text-white text-lg"></i>
                  </div>
                  <h4 class="font-medium mb-1">Our First Memory</h4>
                  <p class="text-xs subtle-text">Click to add a photo</p>
                </div>
              </div>
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden partner-only" id="memory-1-display">
                <!-- Content will be added dynamically -->
              </div>
              <div class="memory-textarea-container">
                <textarea 
                  id="memory-1-text"
                  class="memory-description creator-only"
                  placeholder="Describe this special moment..."
                  rows="2"
                ></textarea>
                <div id="memory-1-text-display" class="partner-only text-center subtle-text p-2 text-sm"></div>
              </div>
            </div>
            
            <!-- Memory 2 -->
            <div class="memory-item">
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only" id="memory-2">
                <div class="text-center p-4">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, var(--sage), var(--moss));">
                    <i class="fas fa-heart text-white text-lg"></i>
                  </div>
                  <h4 class="font-medium mb-1">A Happy Moment</h4>
                  <p class="text-xs subtle-text">Click to add a photo</p>
                </div>
              </div>
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden partner-only" id="memory-2-display">
                <!-- Content will be added dynamically -->
              </div>
              <div class="memory-textarea-container">
                <textarea 
                  id="memory-2-text"
                  class="memory-description creator-only"
                  placeholder="What made this day special?"
                  rows="2"
                ></textarea>
                <div id="memory-2-text-display" class="partner-only text-center subtle-text p-2 text-sm"></div>
              </div>
            </div>
            
            <!-- Memory 3 -->
            <div class="memory-item">
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden bg-gradient-to-br from-blush/20 to-pale-pink/20 border-2 border-dashed border-rose-gold/30 flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-rose-gold/60 hover:scale-[1.02] editable-field creator-only" id="memory-3">
                <div class="text-center p-4">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, var(--rose-gold), var(--soft-pink));">
                    <i class="fas fa-star text-white text-lg"></i>
                  </div>
                  <h4 class="font-medium mb-1">Looking Forward</h4>
                  <p class="text-xs subtle-text">Click to add a photo</p>
                </div>
              </div>
              <div class="memory-image-container aspect-square rounded-xl overflow-hidden partner-only" id="memory-3-display">
                <!-- Content will be added dynamically -->
              </div>
              <div class="memory-textarea-container">
                <textarea 
                  id="memory-3-text"
                  class="memory-description creator-only"
                  placeholder="Our dreams for the future..."
                  rows="2"
                ></textarea>
                <div id="memory-3-text-display" class="partner-only text-center subtle-text p-2 text-sm"></div>
              </div>
            </div>
          </div>
          
          <!-- Music Player -->
          <div class="mb-10">
            <div class="max-w-md mx-auto">
              <div class="text-center mb-6">
                <h3 class="text-xl elegant-font mb-2">Our Song</h3>
                <p class="subtle-text text-sm creator-only">Add a song that reminds you of them</p>
                <p class="subtle-text text-sm partner-only">A special song for us</p>
              </div>
              
              <div class="bg-white rounded-xl p-6 shadow-sm border border-blush">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <div id="song-title" class="font-medium">No song selected</div>
                    <div id="song-status" class="text-sm subtle-text">Upload an MP3 file</div>
                  </div>
                  <button id="upload-song-btn" class="secondary-btn editable-field creator-only bounce-on-hover">
                    <i class="fas fa-upload mr-2"></i>Upload
                  </button>
                </div>
                
                <div class="flex items-center justify-center gap-4">
                  <button id="prev-btn" class="w-10 h-10 rounded-full border border-blush flex items-center justify-center hover:bg-blush/20 editable-field bounce-on-hover">
                    <i class="fas fa-step-backward"></i>
                  </button>
                  
                  <button id="play-btn" class="w-14 h-14 rounded-full primary-btn flex items-center justify-center editable-field shimmer-btn bounce-on-hover">
                    <i id="play-icon" class="fas fa-play"></i>
                    <i id="pause-icon" class="fas fa-pause hidden"></i>
                  </button>
                  
                  <button id="next-btn" class="w-10 h-10 rounded-full border border-blush flex items-center justify-center hover:bg-blush/20 editable-field bounce-on-hover">
                    <i class="fas fa-step-forward"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Navigation -->
          <div class="flex items-center justify-between pt-8 border-t border-blush">
            <!-- Creator Navigation -->
            <button data-section="letter" class="secondary-btn creator-only bounce-on-hover">
              <i class="fas fa-arrow-left mr-2"></i>Back to Letter
            </button>
            
            <button data-section="final" class="primary-btn creator-only shimmer-btn bounce-on-hover">
              Preview & Share
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
            
            <!-- Partner Navigation -->
            <button data-section="letter" class="secondary-btn partner-only bounce-on-hover">
              <i class="fas fa-arrow-left mr-2"></i>Back
            </button>
            
            <button data-section="final" class="primary-btn partner-only shimmer-btn bounce-on-hover">
              Continue
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Final & Share Section -->
    <section id="final" class="section gentle-sway">
      <div class="max-w-3xl w-full fade-in">
        <div class="elegant-card">
          <!-- Partner View -->
          <div class="partner-only text-center">
            <div class="mb-8">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                <i class="fas fa-heart text-white text-2xl"></i>
              </div>
              <h2 class="text-5xl elegant-font mb-4 gradient-text">Thank You</h2>
              <p class="subtle-text text-lg mb-6">For exploring this Heart Map made just for you</p>
              
              <div class="bg-gradient-to-r from-rose-gold/10 to-sage/10 p-6 rounded-xl mb-6">
                <h3 class="text-xl elegant-font mb-4">
                  <span class="animated-smirk">üòè</span> 
                  Create Your Own Response 
                  <span class="animated-blush">üòä</span>
                </h3>
                <p class="subtle-text mb-4">Now you can create your own Heart Map to send back</p>
                <button id="create-your-own-btn" class="primary-btn shimmer-btn bounce-on-hover">
                  <i class="fas fa-heart mr-2"></i>
                  Create Your Heart Map
                </button>
              </div>
            </div>
          </div>
          
          <!-- Creator View -->
          <div class="creator-only">
            <div class="text-center mb-10">
              <div class="inline-flex items-center gap-2 mb-4">
                <span class="completion-checkmark">4</span>
                <span class="text-sm font-medium text-sage">STEP 4 OF 4 - COMPLETE!</span>
              </div>
              
              <div class="mb-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h2 class="text-5xl elegant-font mb-4 gradient-text">Your Heart Map is Ready!</h2>
                <p class="subtle-text text-lg">Preview your creation before sharing it with your loved one</p>
              </div>
            </div>
            
            <!-- Preview Card -->
            <div class="mb-10">
              <div class="bg-gradient-to-br from-blush/20 to-pale-pink/10 rounded-2xl p-8 border border-blush">
                <div class="flex items-center justify-between mb-6">
                  <div>
                    <h3 class="text-2xl elegant-font">Preview</h3>
                    <p class="subtle-text">This is what your partner will see</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-rose-gold animate-pulse"></div>
                    <span class="text-sm font-medium">View Only Mode</span>
                  </div>
                </div>
                
                <div class="space-y-6">
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Personalized greeting for <span id="preview-name" class="font-medium">[Name]</span></span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Love letter with <span id="preview-letter-length" class="font-medium">0</span> words</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span><span id="preview-photo-count" class="font-medium">0</span> memory photos</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Personal soundtrack included</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-sage"></i>
                    <span>Interactive Valentine question with NO button fun</span>
                  </div>
                </div>
                
                <!-- Live Preview Button -->
                <div class="mt-8 pt-6 border-t border-blush">
                  <button id="live-preview-btn" class="primary-btn w-full shimmer-btn bounce-on-hover">
                    <i class="fas fa-eye mr-2"></i>
                    View Live Preview
                  </button>
                  <p class="text-sm subtle-text mt-2 text-center">See exactly what your partner will experience</p>
                </div>
              </div>
            </div>
            
            <!-- Important Note -->
            <div class="mb-10 p-6 rounded-xl bg-gradient-to-r from-rose-gold/5 to-sage/5 border border-rose-gold/20">
              <div class="flex items-start gap-3">
                <i class="fas fa-lock mt-1 text-rose-gold"></i>
                <div>
                  <h4 class="font-medium mb-2">Important: View-Only Mode</h4>
                  <p class="text-sm subtle-text">
                    Once shared, your Heart Map becomes <span class="font-medium">view-only</span> for your partner. 
                    They can experience your love story but cannot edit it. At the end, they'll have the option to create their own Heart Map for you.
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Share Buttons -->
            <div class="space-y-4 mb-8">
              <h3 class="text-xl elegant-font text-center">Share Your Heart Map</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="whatsapp-share" class="secondary-btn flex items-center justify-center gap-3 editable-field bounce-on-hover">
                  <i class="fab fa-whatsapp text-green-500 text-lg"></i>
                  Share via WhatsApp
                </button>
                
                <button id="copy-link" class="secondary-btn flex items-center justify-center gap-3 editable-field bounce-on-hover">
                  <i class="fas fa-link text-rose-gold text-lg"></i>
                  Copy Link
                </button>
              </div>
              
              <div class="text-center">
                <button id="save-draft" class="text-sm subtle-text hover:text-rose-gold transition-colors editable-field">
                  <i class="fas fa-save mr-1"></i>
                  Save as draft to continue later
                </button>
              </div>
            </div>
            
            <!-- Settings Button -->
            <div class="mt-6 text-center">
              <button id="edit-no-phrases" class="secondary-btn bounce-on-hover">
                <i class="fas fa-cog mr-2"></i>
                Edit Valentine NO Button Phrases
              </button>
              <p class="text-xs subtle-text mt-2">
                Customize what appears when your partner clicks "NO" on the Valentine question
              </p>
            </div>
            
            <!-- Final Navigation -->
            <div class="flex items-center justify-between pt-8 border-t border-blush">
              <button data-section="memories" class="secondary-btn bounce-on-hover">
                <i class="fas fa-edit mr-2"></i>Edit
              </button>
              
              <div class="flex items-center gap-2 subtle-text">
                <i class="fas fa-info-circle"></i>
                <span class="text-sm">Data is automatically saved</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Hidden File Inputs -->
  <input type="file" id="image-upload" class="hidden" accept="image/*">
  <input type="file" id="audio-upload" class="hidden" accept="audio/*">
  <audio id="audio-player" class="hidden"></audio>
  
  <script>
    // ========== STATE MANAGEMENT ==========
    const HeartMapState = {
      isCreator: true,
      isViewOnly: false,
      currentSection: 'welcome',
      completedSections: new Set(['welcome']),
      data: {
        partnerName: '',
        yourName: '',
        letter: {
          date: 'February 14, 2026',
          opening: '',
          body: '',
          promise: '',
          closing: ''
        },
        memories: [{}, {}, {}],
        song: null,
        noButtonPhrases: [
          "No Pushing Me Away üòè",
          "Maybe later ü§™",
          "Try Again üòõ",
          "Are You Sure? ü•∫",
          "Can we talk first? üò≠",
          "Please Think Again üò≠",
          "Are You Perhaps Shy? ü§≠",
          "Nah, Not This Easily üòè",
          "Let's think thoroughly ü•∫ ",
          "Come on, baby ü•∫",
          "You Are Tired Of Saying No üòπ"
        ]
      },
      save() {
        // Compress images before saving
        const dataToSave = {
          partnerName: this.data.partnerName,
          yourName: this.data.yourName,
          letter: this.data.letter,
          memories: this.data.memories.map(mem => {
            if (mem && mem.image) {
              // Compress image if it's too large
              const compressed = this.compressImageData(mem.image);
              return {
                caption: mem.caption || '',
                image: compressed,
                originalSize: mem.image.length,
                compressedSize: compressed.length
              };
            }
            return { caption: mem.caption || '' };
          }),
          song: this.data.song ? { name: this.data.song.name } : null,
          noButtonPhrases: this.data.noButtonPhrases
        };
        
        try {
          localStorage.setItem('heartMapData', JSON.stringify(dataToSave));
          localStorage.setItem('heartMapCompleted', JSON.stringify([...this.completedSections]));
          localStorage.setItem('heartMapCreator', this.isCreator.toString());
          return this.generateShareId();
        } catch (e) {
          console.warn('Could not save to localStorage:', e.message);
          // Try saving without images
          const dataWithoutImages = {
            ...dataToSave,
            memories: dataToSave.memories.map(mem => ({ caption: mem.caption || '' }))
          };
          try {
            localStorage.setItem('heartMapData', JSON.stringify(dataWithoutImages));
            return this.generateShareId();
          } catch (e2) {
            // Last resort: save only essential data
            const essentialData = {
              partnerName: dataToSave.partnerName,
              yourName: dataToSave.yourName,
              letter: dataToSave.letter,
              noButtonPhrases: dataToSave.noButtonPhrases
            };
            localStorage.setItem('heartMapData', JSON.stringify(essentialData));
            return null;
          }
        }
      },
      compressImageData(imageData) {
        // Simple image compression by reducing quality
        if (imageData.length > 100000) { // If larger than 100KB
          // For base64 images, we can't easily compress them in browser
          // So we'll just store a placeholder for large images
          return imageData.substring(0, 50000) + "...[COMPRESSED]";
        }
        return imageData;
      },
      load() {
        const saved = localStorage.getItem('heartMapData');
        const completed = localStorage.getItem('heartMapCompleted');
        const creator = localStorage.getItem('heartMapCreator');
        
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            this.data = {
              ...this.data, // Keep defaults
              ...parsed,    // Override with saved data
              // Ensure all arrays exist
              memories: parsed.memories || [{}, {}, {}],
              noButtonPhrases: parsed.noButtonPhrases || this.data.noButtonPhrases
            };
          } catch (e) {
            console.error('Error parsing saved data:', e);
          }
        }
        
        if (completed) this.completedSections = new Set(JSON.parse(completed));
        if (creator) this.isCreator = creator === 'true';
        return this;
      },
      reset() {
        this.data = {
          partnerName: '',
          yourName: '',
          letter: {
            date: 'February 14, 2026',
            opening: '',
            body: '',
            promise: '',
            closing: ''
          },
          memories: [{}, {}, {}],
          song: null,
          noButtonPhrases: [
            "No Pushing Me Away üòè",
            "Maybe later ü§™",
            "Try Again üòõ",
            "Are You Sure? ü•∫",
            "Can we talk first? üò≠",
            "Please Think Again üò≠",
            "Are You Perhaps Shy? ü§≠",
            "Nah, Not This Easily üòè",
            "Let's think thoroughly ü•∫ ",
            "Come on, baby ü•∫",
            "You Are Tired Of Saying No üòπ"
          ]
        };
        this.completedSections = new Set(['welcome']);
        this.isCreator = true;
        this.save();
      },
      generateShareId() {
        try {
          // Clean up old shares first
          this.cleanupOldShares();
          
          // Generate a unique ID for sharing
          const shareId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
          localStorage.setItem('heartMapShareId', shareId);
          
          // Save minimal data for sharing (no images)
          const shareData = {
            id: shareId,
            data: JSON.stringify({
              partnerName: this.data.partnerName,
              yourName: this.data.yourName,
              letter: this.data.letter,
              memories: this.data.memories.map(mem => ({ caption: mem.caption || '' })),
              noButtonPhrases: this.data.noButtonPhrases
            }),
            completed: JSON.stringify([...this.completedSections]),
            timestamp: Date.now()
          };
          
          localStorage.setItem(`heartMap_${shareId}`, JSON.stringify(shareData));
          
          return shareId;
        } catch (e) {
          console.error('Error generating share ID:', e);
          return null;
        }
      },
      loadFromShareId(shareId) {
        const shareKey = `heartMap_${shareId}`;
        const shareData = localStorage.getItem(shareKey);
        
        if (shareData) {
          try {
            const parsed = JSON.parse(shareData);
            
            if (parsed.data) {
              const loadedData = JSON.parse(parsed.data);
              this.data = {
                ...this.data,
                ...loadedData,
                memories: loadedData.memories || [{}, {}, {}]
              };
            }
            if (parsed.completed) {
              this.completedSections = new Set(JSON.parse(parsed.completed));
            }
            
            this.isCreator = false;
            this.isViewOnly = true;
            return true;
          } catch (e) {
            console.error('Error loading shared data:', e);
            return false;
          }
        }
        return false;
      },
      cleanupOldShares() {
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000); // 24 hours
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('heartMap_')) {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data.timestamp && data.timestamp < oneDayAgo) {
                localStorage.removeItem(key);
              }
            } catch (e) {
              // Remove corrupted entries
              localStorage.removeItem(key);
            }
          }
        }
      }
    };

    // Track NO button state
    let noButtonClickCount = 0;
    let isNoButtonFloating = false;
    let currentNoButton = null;
    let currentMemoryIndex = 0;
    
    // ========== ENHANCED ANIMATIONS FUNCTIONS ==========
    
    function initEnhancedAnimations() {
      // Create twinkling stars
      createTwinklingStars();
      setInterval(createTwinklingStars, 3000);
      
      // Create floating leaves
      createFloatingLeaves();
      setInterval(createFloatingLeaves, 4000);
      
      // Create animated emojis
      createAnimatedEmojis();
      setInterval(createAnimatedEmojis, 5000);
      
      // Add gentle sway to cards
      document.querySelectorAll('.elegant-card, .glass-card').forEach((card, index) => {
        card.classList.add('gentle-sway');
        card.style.animationDelay = `${index * 0.2}s`;
      });
      
      // Add glow pulse to active navigation dots
      document.querySelectorAll('.nav-dot.active').forEach(dot => {
        dot.classList.add('glow-pulse');
      });
      
      // Add hover animations to buttons
      document.querySelectorAll('.primary-btn, .secondary-btn').forEach(btn => {
        btn.classList.add('bounce-on-hover');
        if (btn.classList.contains('primary-btn')) {
          btn.classList.add('shimmer-btn');
        }
      });
    }
    
    function createTwinklingStars() {
      const container = document.getElementById('floating-container');
      
      for (let i = 0; i < 3; i++) {
        const star = document.createElement('div');
        star.className = 'twinkle';
        
        const size = Math.random() * 3 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${Math.random() * 100}vw`;
        star.style.top = `${Math.random() * 100}vh`;
        star.style.opacity = Math.random() * 0.3 + 0.1;
        star.style.animationDuration = `${Math.random() * 3 + 2}s`;
        star.style.animationDelay = `${Math.random() * 2}s`;
        
        container.appendChild(star);
        setTimeout(() => star.remove(), 6000);
      }
    }
    
    function createFloatingLeaves() {
      const container = document.getElementById('floating-container');
      const leaves = ['üçÅ', 'üåø', 'ü¶ã', 'üå∏'];
      
      for (let i = 0; i < 2; i++) {
        const leaf = document.createElement('div');
        leaf.className = 'floating-leaf';
        leaf.textContent = leaves[Math.floor(Math.random() * leaves.length)];
        
        leaf.style.left = `${Math.random() * 100}vw`;
        leaf.style.fontSize = `${Math.random() * 20 + 16}px`;
        leaf.style.color = getRandomGreen();
        leaf.style.animationDuration = `${Math.random() * 15 + 20}s`;
        
        container.appendChild(leaf);
        setTimeout(() => leaf.remove(), 30000);
      }
    }
    
    function createAnimatedEmojis() {
      const container = document.getElementById('emoji-container');
      const emojis = ['üåπ', 'ü¶ã', 'üå∏', 'üåø', 'üçÅ', 'üçÄ'];
      
      for (let i = 0; i < 4; i++) {
        const emoji = document.createElement('div');
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.className = 'emoji-particle';
        emoji.textContent = randomEmoji;
        
        // Add specific animation class based on emoji
        if (randomEmoji === 'üòè') emoji.classList.add('animated-smirk');
        if (randomEmoji === 'üòâ') emoji.classList.add('animated-wink');
        if (randomEmoji === 'üòä') emoji.classList.add('animated-blush');
        if (randomEmoji === 'üòç') emoji.classList.add('animated-heart-eyes');
        if (randomEmoji.includes('üíñ') || randomEmoji.includes('üíï') || randomEmoji.includes('üíò') || randomEmoji.includes('üíù')) {
          emoji.classList.add('emoji-pulse');
        }
        
        emoji.style.left = `${Math.random() * 100}vw`;
        emoji.style.fontSize = `${Math.random() * 24 + 20}px`;
        emoji.style.color = getRandomPink();
        emoji.style.animationDuration = `${Math.random() * 15 + 10}s`;
        
        // Make some emojis interactive
        if (Math.random() > 0.5) {
          emoji.style.cursor = 'pointer';
          emoji.style.pointerEvents = 'auto';
          emoji.addEventListener('click', () => {
            // Create a burst effect when clicked
            createEmojiBurst(emoji.textContent, emoji.getBoundingClientRect().left, emoji.getBoundingClientRect().top);
            emoji.remove();
          });
        }
        
        container.appendChild(emoji);
        setTimeout(() => {
          if (emoji.parentElement === container) {
            container.removeChild(emoji);
          }
        }, 30000);
      }
    }
    
    function createEmojiBurst(emoji, x, y) {
      const container = document.getElementById('emoji-container');
      
      for (let i = 0; i < 8; i++) {
        const burstEmoji = document.createElement('div');
        burstEmoji.className = 'emoji-particle';
        burstEmoji.textContent = emoji;
        burstEmoji.style.left = `${x}px`;
        burstEmoji.style.top = `${y}px`;
        burstEmoji.style.fontSize = '20px';
        burstEmoji.style.animationDuration = '1.5s';
        burstEmoji.style.animationTimingFunction = 'ease-out';
        
        // Random direction
        const angle = (i / 8) * Math.PI * 2;
        const distance = 100;
        burstEmoji.style.setProperty('--end-x', `${Math.cos(angle) * distance}px`);
        burstEmoji.style.setProperty('--end-y', `${Math.sin(angle) * distance}px`);
        
        // Custom animation for burst
        burstEmoji.style.animation = `burst 1.5s ease-out forwards`;
        
        // Define burst animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes burst {
            0% {
              transform: translate(0, 0) scale(1);
              opacity: 1;
            }
            100% {
              transform: translate(var(--end-x), var(--end-y)) scale(0);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
        
        container.appendChild(burstEmoji);
        setTimeout(() => burstEmoji.remove(), 1500);
      }
    }
    
    function getRandomPink() {
      const pinks = ['#B76E79', '#C9A9A6', '#E8B4B8', '#F5C6D6'];
      return pinks[Math.floor(Math.random() * pinks.length)];
    }
    
    function getRandomGreen() {
      const greens = ['#7D8B6F', '#5C6B4F', '#6B7B5E', '#8A9B7C', '#4A5D3E'];
      return greens[Math.floor(Math.random() * greens.length)];
    }
    
    function navigateToSectionWithAnimation(sectionId) {
      const currentSection = document.getElementById(HeartMapState.currentSection);
      const newSection = document.getElementById(sectionId);
      
      if (!currentSection || !newSection) return;
      
      // Add exit animation
      currentSection.classList.add('fade-out');
      
      // After fade out, hide current and show new with entrance animation
      setTimeout(() => {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('active');
          section.classList.remove('fade-in');
          section.classList.remove('fade-out');
          section.classList.remove('slide-in-right', 'slide-in-left', 'slide-in-up');
        });
        
        // Show new section with entrance animation
        newSection.classList.add('active');
        
        // Determine direction for slide animation
        const sections = ['valentine-question', 'welcome', 'greeting', 'letter', 'memories', 'final'];
        const currentIndex = sections.indexOf(HeartMapState.currentSection);
        const newIndex = sections.indexOf(sectionId);
        
        if (newIndex > currentIndex) {
          newSection.classList.add('slide-in-right');
        } else if (newIndex < currentIndex) {
          newSection.classList.add('slide-in-left');
        } else {
          newSection.classList.add('slide-in-up');
        }
        
        HeartMapState.currentSection = sectionId;
        
        // Mark as completed
        if (sectionId !== 'valentine-question' && !HeartMapState.completedSections.has(sectionId)) {
          HeartMapState.completedSections.add(sectionId);
          HeartMapState.save();
        }
        
        updateNavigationDots();
        updateProgress();
        
        // Update glow pulse on active nav dot
        document.querySelectorAll('.nav-dot').forEach(dot => {
          dot.classList.remove('glow-pulse');
        });
        const activeDot = document.querySelector(`.nav-dot[data-section="${sectionId}"]`);
        if (activeDot) activeDot.classList.add('glow-pulse');
        
      }, 500); // Match the fade-out animation duration
    }
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Clean up localStorage first
      cleanupLocalStorage();
      
      // Load saved state
      HeartMapState.load();
      
      // Check if viewing as partner via share ID
      const urlParams = new URLSearchParams(window.location.search);
      const shareId = urlParams.get('id');
      
      if (shareId) {
        // Try to load shared data
        const success = HeartMapState.loadFromShareId(shareId);
        
        if (success) {
          document.body.classList.add('view-only');
          document.body.classList.remove('creator-mode');
          
          // Update partner view with creator's data
          updatePartnerView();
          
          // Set up partner mode navigation
          const viewLetterBtn = document.getElementById('view-letter-btn');
          if (viewLetterBtn) {
            viewLetterBtn.addEventListener('click', () => {
              navigateToSectionWithAnimation('greeting');
            });
          }
          
          // Set current section to valentine question
          HeartMapState.currentSection = 'valentine-question';
          
          // Initialize Valentine screen first
          initValentineScreen();
        } else {
          // If no shared data found, show error and redirect to creator mode
          showNotification('This Heart Map link has expired or is invalid. Creating a new one...');
          HeartMapState.reset();
          document.body.classList.add('creator-mode');
        }
      } else {
        // Creator mode
        document.body.classList.add('creator-mode');
        document.body.classList.remove('view-only');
        
        // Generate share ID if none exists
        if (!localStorage.getItem('heartMapShareId')) {
          HeartMapState.generateShareId();
        }
      }
      
      // Initialize components
      initEnhancedAnimations();
      initNavigation();
      initFormBindings();
      initMediaUpload();
      initMemoryTextBindings();
      initMusicPlayer();
      initShareFunctions();
      initPreviewFunctions();
      initPreviewUpdates();
      initSettingsPanel();
      
      // Update UI based on state
      updateUIFromState();
      updateProgress();
      
      // Show the current section
      showCurrentSection();
      
      console.log('Heart Map initialized with enhanced animations!');
    });
    
    // ========== CLEANUP LOCALSTORAGE ==========
    function cleanupLocalStorage() {
      const keysToKeep = ['heartMapData', 'heartMapCompleted', 'heartMapCreator', 'heartMapShareId'];
      
      // Clean up old data
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && (key.startsWith('blob:') || 
            (key.startsWith('heartMap_') && !keysToKeep.includes(key)))) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            // Keep only recent shares (last 24 hours)
            if (data && data.timestamp && Date.now() - data.timestamp > 24 * 60 * 60 * 1000) {
              localStorage.removeItem(key);
            }
          } catch (e) {
            // Remove corrupted entries
            localStorage.removeItem(key);
          }
        }
      }
    }
    
    // ========== SETTINGS PANEL (NO Button Phrases) ==========
    function initSettingsPanel() {
      const openSettingsBtn = document.getElementById('open-settings');
      const editNoPhrasesBtn = document.getElementById('edit-no-phrases');
      const closeSettingsBtn = document.getElementById('close-settings');
      const settingsOverlay = document.getElementById('settings-overlay');
      const settingsPanel = document.getElementById('settings-panel');
      const addPhraseBtn = document.getElementById('add-phrase');
      const resetPhrasesBtn = document.getElementById('reset-phrases');
      
      // Open settings panel
      function openSettings() {
        settingsOverlay.classList.add('active');
        settingsPanel.classList.add('active');
        loadNoPhrases();
      }
      
      // Close settings panel
      function closeSettings() {
        settingsOverlay.classList.remove('active');
        settingsPanel.classList.remove('active');
      }
      
      // Load phrases into editor
      function loadNoPhrases() {
        const phrasesList = document.getElementById('no-phrases-list');
        phrasesList.innerHTML = '';
        
        HeartMapState.data.noButtonPhrases.forEach((phrase, index) => {
          const phraseDiv = document.createElement('div');
          phraseDiv.className = 'flex items-center gap-2';
          phraseDiv.innerHTML = `
            <input type="text" 
                   class="flex-1 p-2 border border-blush rounded-lg focus:outline-none focus:border-rose-gold" 
                   value="${phrase.replace(/"/g, '&quot;')}"
                   data-index="${index}">
            <button class="w-8 h-8 rounded-full bg-rose-gold/10 text-rose-gold flex items-center justify-center hover:bg-rose-gold/20 remove-phrase" data-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          `;
          phrasesList.appendChild(phraseDiv);
        });
        
        // Add event listeners to inputs
        phrasesList.querySelectorAll('input').forEach(input => {
          input.addEventListener('input', (e) => {
            const index = parseInt(e.target.dataset.index);
            HeartMapState.data.noButtonPhrases[index] = e.target.value;
            HeartMapState.save();
          });
        });
        
        // Add event listeners to remove buttons
        phrasesList.querySelectorAll('.remove-phrase').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('button').dataset.index);
            HeartMapState.data.noButtonPhrases.splice(index, 1);
            HeartMapState.save();
            loadNoPhrases(); // Reload list
          });
        });
      }
      
      // Add new phrase
      addPhraseBtn.addEventListener('click', () => {
        HeartMapState.data.noButtonPhrases.push('New phrase...');
        HeartMapState.save();
        loadNoPhrases();
      });
      
      // Reset to default phrases
      resetPhrasesBtn.addEventListener('click', () => {
        HeartMapState.data.noButtonPhrases = [
          "No Pushing Me Away üòè",
          "Maybe later ü§™",
          "Try Again üòõ",
          "Are You Sure? ü•∫",
          "Pleaseeee üò≠",
          "Don't Punish Me Like This!!üò≠",
          "Are You Perhaps Shy? ü§≠",
          "Nah, Not This Easily üòè",
          "Let's think thoroughly ü•∫ ",
          "Come on, baby ü•∫",
          "You Can't Say No üòπ"
        ];
        HeartMapState.save();
        loadNoPhrases();
        showNotification('‚úÖ NO button phrases reset to defaults!');
      });
      
      // Event listeners
      if (openSettingsBtn) openSettingsBtn.addEventListener('click', openSettings);
      if (editNoPhrasesBtn) editNoPhrasesBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      settingsOverlay.addEventListener('click', closeSettings);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsPanel.classList.contains('active')) {
          closeSettings();
        }
      });
    }
    
    // ========== PREVIEW FUNCTIONS ==========
    function initPreviewFunctions() {
      // Live preview button
      document.getElementById('live-preview-btn').addEventListener('click', showLivePreview);
      
      // Close preview button
      document.getElementById('close-preview').addEventListener('click', closePreview);
    }
    
    function showLivePreview() {
      // Save current state
      try {
        HeartMapState.save();
      } catch (e) {
        console.warn('Could not save for preview:', e);
      }
      
      // Show preview container
      const previewContainer = document.getElementById('preview-container');
      const previewContent = document.getElementById('preview-content');
      
      // Generate HTML for partner view (including Valentine screen)
      let previewHTML = '';
      
      // Valentine question screen
      previewHTML += `
        <div class="text-center max-w-3xl w-full mx-auto mb-8">
          <div class="elegant-card">
            <div class="mb-8">
              <div class="inline-flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-xl"></i>
                </div>
                <h1 class="text-4xl elegant-font">Heart Map</h1>
              </div>
              <p class="subtle-text mb-2">A Special Question For You</p>
            </div>
            
            <div class="mb-12">
              <div class="w-48 h-48 mx-auto mb-8 relative">
                <div class="absolute inset-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--rose-gold), var(--deep-pink));">
                  <i class="fas fa-heart text-white text-6xl heartbeat"></i>
                </div>
              </div>
              
              <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">Will You Be My Valentine?</h2>
              
              <p class="text-xl subtle-text mb-6 max-w-2xl mx-auto">
                My heart has mapped its course, and it leads straight to you. 
                Will you be mine on this journey of love?
              </p>
              
              <div class="inline-block px-6 py-3 rounded-full bg-blush/30 mb-8">
                <span class="text-2xl script-font gradient-text">${HeartMapState.data.partnerName || 'My Dearest'}</span>
              </div>
            </div>
            
            <div class="space-y-6 max-w-md mx-auto">
              <button class="primary-btn w-full shimmer-btn">
                <span class="flex items-center justify-center gap-3 text-xl">
                  <i class="fas fa-heart"></i>
                  Yes, With All My Heart!
                  <i class="fas fa-heart"></i>
                </span>
              </button>
              
              <div class="w-full flex justify-center">
                <button class="no-btn w-full max-w-sm">
                  <i class="fas fa-times"></i> ${HeartMapState.data.noButtonPhrases[0] || 'No Never!'}
                </button>
              </div>
              
              <div class="mt-4 p-4 rounded-lg bg-rose-gold/10 border border-rose-gold/20">
                <p class="subtle-text">
                  <span class="animated-smirk">üòè</span>
                  <span class="ml-2">I know you're just being shy! The "Yes" button is waiting patiently...</span>
                </p>
              </div>
              
              <p class="text-sm subtle-text mt-6">
                <i class="fas fa-info-circle mr-1"></i>
                Keep clicking the NO button to see it move around!
              </p>
            </div>
          </div>
        </div>
      `;
      
      // Welcome screen
      previewHTML += `
        <div class="text-center max-w-3xl w-full mx-auto mb-8">
          <div class="elegant-card">
            <div class="mb-8">
              <div class="inline-flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-heart text-white text-xl"></i>
                </div>
                <h1 class="text-4xl elegant-font">Heart Map</h1>
              </div>
              <p class="subtle-text mb-2">An Interactive Love Letter</p>
            </div>
            
            <div class="mb-10">
              <div class="relative inline-block">
                <div class="w-48 h-48 mx-auto rounded-full flex items-center justify-center gentle-pulse" style="background: linear-gradient(135deg, rgba(125, 139, 111, 0.1), rgba(183, 110, 121, 0.1));">
                  <svg class="w-32 h-32" fill="url(#heartGradient)" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <h2 class="text-5xl md:text-6xl elegant-font mb-6 gradient-text">Welcome to My Heart Map</h2>
            
            <p class="text-xl subtle-text mb-10 max-w-2xl mx-auto">
              You've received a special love letter! Created just for you by your devotee.
              Every click reveals more of my heartfelt confession.
            </p>
            
            <div class="space-y-4">
              <button class="primary-btn w-full max-w-sm mx-auto shimmer-btn">
                <span class="flex items-center justify-center gap-2">
                  <i class="fas fa-heart"></i>
                  Open Your Love Letter
                </span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Greeting screen
      previewHTML += `
        <div class="max-w-2xl w-full mx-auto mb-8">
          <div class="elegant-card">
            <div class="mb-8 text-center">
              <h2 class="text-4xl elegant-font mb-4">For My Dearest ${HeartMapState.data.partnerName || '[Name]'}</h2>
              <p class="subtle-text">A heartfelt message just for you</p>
            </div>
            
            <div class="text-center mb-8">
              <h3 class="text-3xl script-font gradient-text">My Dearest ${HeartMapState.data.partnerName || '[Name]'}</h3>
            </div>
            
            <div class="text-center mt-12">
              <button class="primary-btn shimmer-btn">
                Read Your Love Letter
                <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Letter screen
      previewHTML += `
        <div class="max-w-3xl w-full mx-auto mb-8">
          <div class="glass-card">
            <div class="mb-8 text-center">
              <h2 class="text-4xl elegant-font mb-4">Your Love Letter</h2>
              <p class="subtle-text mb-6">A message from the heart</p>
            </div>
            
            <div class="space-y-6">
              <div class="text-right">
                <p class="subtle-text text-lg">${HeartMapState.data.letter.date || 'February 14, 2026'}</p>
              </div>
              
              <div class="text-center mb-8">
                <h3 class="text-3xl script-font gradient-text">My Dearest ${HeartMapState.data.partnerName || '[Name]'}</h3>
              </div>
              
              <div class="space-y-8">
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.opening || 'My love, the moment I met you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.body || 'I love everything about you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.promise || 'I promise to always love you...'}</p>
                </div>
                
                <div>
                  <p class="text-lg subtle-text leading-relaxed">${HeartMapState.data.letter.closing || 'With all my love...'}</p>
                </div>
              </div>
              
              <div class="text-center mt-12 pt-8 border-t border-blush">
                <div class="mb-4">
                  <span class="text-3xl script-font gradient-text">${HeartMapState.data.yourName || 'Your Valentine'}</span>
                </div>
                <p class="text-sm subtle-text italic">Forever yours</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Memories screen
      previewHTML += `
        <div class="max-w-6xl w-full mx-auto mb-8">
          <div class="glass-card">
            <div class="mb-10 text-center">
              <h2 class="text-4xl elegant-font mb-4">Our Treasured Moments</h2>
              <p class="subtle-text mb-6">Special memories we've shared together</p>
            </div>
            
            <div class="memory-grid mb-12">
      `;
      
      // Add memory previews
      for (let i = 0; i < 3; i++) {
        const memory = HeartMapState.data.memories[i] || {};
        previewHTML += `
          <div class="memory-item">
            <div class="memory-image-container aspect-square rounded-xl overflow-hidden">
              ${memory.image && !memory.image.includes('[COMPRESSED]') ? 
                `<img src="${memory.image}" class="w-full h-full object-cover rounded-xl" alt="Memory ${i+1}">` : 
                `<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blush/20 to-pale-pink/20">
                  <div class="text-center p-6">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, ${i === 0 ? 'var(--rose-gold), var(--deep-pink)' : i === 1 ? 'var(--sage), var(--moss)' : 'var(--rose-gold), var(--soft-pink)'});">
                      <i class="fas fa-${i === 0 ? 'camera' : i === 1 ? 'heart' : 'star'} text-white text-lg"></i>
                    </div>
                    <h4 class="font-medium mb-1">${i === 0 ? 'Our First Memory' : i === 1 ? 'A Happy Moment' : 'Looking Forward'}</h4>
                  </div>
                </div>`
              }
            </div>
            <div class="mt-4">
              <div class="text-center subtle-text p-3 bg-white/90 rounded-lg">${memory.caption || 'No description yet'}</div>
            </div>
          </div>
        `;
      }
      
      previewHTML += `
            </div>
          </div>
        </div>
      `;
      
      // Final screen
      previewHTML += `
        <div class="max-w-3xl w-full mx-auto">
          <div class="elegant-card">
            <div class="text-center">
              <div class="mb-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" style="background: linear-gradient(135deg, var(--sage), var(--rose-gold));">
                  <i class="fas fa-heart text-white text-2xl"></i>
                </div>
                <h2 class="text-5xl elegant-font mb-4 gradient-text">Thank You</h2>
                <p class="subtle-text text-lg mb-6">For exploring this Heart Map made just for you</p>
                
                <div class="bg-gradient-to-r from-rose-gold/10 to-sage/10 p-6 rounded-xl mb-6">
                  <h3 class="text-xl elegant-font mb-4">
                    <span class="animated-smirk">üòè</span> 
                    Create Your Own Response 
                    <span class="animated-blush">üòä</span>
                  </h3>
                  <p class="subtle-text mb-4">Now you can create your own Heart Map to send back</p>
                  <button class="primary-btn shimmer-btn">
                    <i class="fas fa-heart mr-2"></i>
                    Create Your Heart Map
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      previewContent.innerHTML = previewHTML;
      previewContainer.classList.add('active');
    }
    
    function closePreview() {
      document.getElementById('preview-container').classList.remove('active');
    }
    
    // ========== VALENTINE QUESTION SCREEN ==========
    function initValentineScreen() {
      // Only show if viewing as partner
      if (HeartMapState.isViewOnly && !HeartMapState.isCreator) {
        // Navigate to valentine question screen
        navigateToSectionWithAnimation('valentine-question');
        
        // Update partner name if available
        if (HeartMapState.data.partnerName) {
          document.getElementById('valentine-partner-name').textContent = HeartMapState.data.partnerName;
        }
        
        // Create floating hearts for background
        createValentineHearts();
        setInterval(createValentineHearts, 2000);
        
        // Set up the YES button
        const yesBtn = document.getElementById('yes-valentine-btn');
        const initialNoBtn = document.getElementById('initial-no-btn');
        const secretMessage = document.getElementById('secret-message');
        
        // Yes button - takes them to the actual content
        yesBtn.addEventListener('click', () => {
          // Create celebration effect
          createCelebration();
          
          // Show success message
          showNotification('üíñ Yes! You\'ve made my heart complete! üíñ');
          
          // Remove all NO buttons
          if (currentNoButton) {
            currentNoButton.remove();
          }
          if (initialNoBtn) initialNoBtn.remove();
          
          // Navigate to welcome screen after a delay
          setTimeout(() => {
            navigateToSectionWithAnimation('welcome');
          }, 1500);
        });
        
        // Initial NO button (beside YES)
        if (initialNoBtn) {
          initialNoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            noButtonClickCount++;
            
            // Vibrate on mobile
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
            
            // After first click, move NO button to random position
            if (noButtonClickCount === 1) {
              // Hide the initial NO button
              this.style.opacity = '0';
              this.style.transform = 'scale(0.8)';
              
              // Create floating NO button
              setTimeout(() => {
                this.style.display = 'none';
                createFloatingNoButton();
              }, 300);
            }
            
            // Update secret message after 3 clicks
            if (noButtonClickCount >= 3 && secretMessage && !secretMessage.classList.contains('show')) {
              secretMessage.classList.remove('hidden');
              secretMessage.classList.add('show');
              secretMessage.style.animation = 'fadeIn 0.5s ease-out';
            }
          });
        }
      }
    }
    
    function createFloatingNoButton() {
      // Remove existing floating NO button if any
      if (currentNoButton) {
        currentNoButton.remove();
      }
      
      const container = document.getElementById('no-button-container');
      const phrases = HeartMapState.data.noButtonPhrases;
      const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
      
      currentNoButton = document.createElement('button');
      currentNoButton.className = 'no-btn';
      currentNoButton.innerHTML = `<i class="fas fa-times"></i> ${randomPhrase}`;
      currentNoButton.title = randomPhrase;
      
      // Random position (not too close to edges)
      const maxX = window.innerWidth - 200;
      const maxY = window.innerHeight - 100;
      const randomX = Math.floor(Math.random() * maxX) + 50;
      const randomY = Math.floor(Math.random() * maxY) + 50;
      
      currentNoButton.style.left = `${randomX}px`;
      currentNoButton.style.top = `${randomY}px`;
      
      // Add click event
      currentNoButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        noButtonClickCount++;
        
        // Vibrate on mobile
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        
        // Change phrase
        const newPhrase = phrases[Math.floor(Math.random() * phrases.length)];
        this.innerHTML = `<i class="fas fa-times"></i> ${newPhrase}`;
        this.title = newPhrase;
        
        // Move to new random position
        const newX = Math.floor(Math.random() * maxX) + 50;
        const newY = Math.floor(Math.random() * maxY) + 50;
        
        // Animate movement
        this.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        this.style.left = `${newX}px`;
        this.style.top = `${newY}px`;
        
        // Update secret message after 3 clicks
        const secretMessage = document.getElementById('secret-message');
        if (noButtonClickCount >= 3 && secretMessage && !secretMessage.classList.contains('show')) {
          secretMessage.classList.remove('hidden');
          secretMessage.classList.add('show');
          secretMessage.style.animation = 'fadeIn 0.5s ease-out';
        }
      });
      
      container.appendChild(currentNoButton);
      isNoButtonFloating = true;
    }
    
    function createValentineHearts() {
      const container = document.getElementById('valentine-hearts-container');
      const heartTypes = ['‚ù§Ô∏è‚Äçüî•', 'üíö', '‚ù£Ô∏è', 'ü§é', 'üíò',];
      
      for (let i = 0; i < 8; i++) {
        const heart = document.createElement('div');
        const type = heartTypes[Math.floor(Math.random() * heartTypes.length)];
        
        heart.textContent = type;
        heart.className = 'absolute pointer-events-none';
        heart.style.fontSize = `${Math.random() * 20 + 16}px`;
        heart.style.opacity = Math.random() * 0.3 + 0.1;
        heart.style.left = `${Math.random() * 100}%`;
        heart.style.top = `${Math.random() * 100}%`;
        heart.style.color = getRandomPink();
        heart.style.animation = `floatUp ${Math.random() * 20 + 10}s linear infinite`;
        heart.style.animationDelay = `${Math.random() * 5}s`;
        
        container.appendChild(heart);
        
        // Remove after animation completes
        setTimeout(() => {
          if (heart.parentElement === container) {
            container.removeChild(heart);
          }
        }, 30000);
      }
    }
    
    function createCelebration() {
      const container = document.getElementById('emoji-container');
      const celebrations = ['üéâ', '‚ú®', 'üåü', 'üí´', 'ü•≥', 'üéä', 'üíñ', 'üíù'];
      
      for (let i = 0; i < 20; i++) {
        const celeb = document.createElement('div');
        const type = celebrations[Math.floor(Math.random() * celebrations.length)];
        
        celeb.textContent = type;
        celeb.className = 'fixed pointer-events-none z-50';
        celeb.style.fontSize = `${Math.random() * 24 + 20}px`;
        celeb.style.opacity = '1';
        celeb.style.left = `${Math.random() * 100}vw`;
        celeb.style.top = `${Math.random() * 100}vh`;
        celeb.style.animation = `floatUp ${Math.random() * 2 + 1}s ease-out forwards`;
        
        container.appendChild(celeb);
        setTimeout(() => celeb.remove(), 2000);
      }
    }
    
    // ========== UPDATE PARTNER VIEW ==========
    function updatePartnerView() {
      // Update display elements with loaded data
      const partnerNameDisplay = document.getElementById('partner-name-display');
      const partnerNameDisplayText = document.getElementById('partner-name-display-text');
      const letterDateDisplay = document.getElementById('letter-date-display');
      
      if (partnerNameDisplay) partnerNameDisplay.textContent = HeartMapState.data.partnerName || 'My Love';
      if (partnerNameDisplayText) partnerNameDisplayText.textContent = HeartMapState.data.partnerName || 'My Love';
      if (letterDateDisplay) letterDateDisplay.textContent = HeartMapState.data.letter.date || 'February 14, 2026';
      
      // Update letter content displays
      const openingDisplay = document.getElementById('letter-opening-display');
      const bodyDisplay = document.getElementById('letter-body-display');
      const promiseDisplay = document.getElementById('letter-promise-display');
      const closingDisplay = document.getElementById('letter-closing-display');
      const signatureDisplay = document.getElementById('letter-signature-display');
      
      if (openingDisplay) openingDisplay.textContent = HeartMapState.data.letter.opening || 'My love, the moment I met you...';
      if (bodyDisplay) bodyDisplay.textContent = HeartMapState.data.letter.body || 'I love everything about you...';
      if (promiseDisplay) promiseDisplay.textContent = HeartMapState.data.letter.promise || 'I promise to always love you...';
      if (closingDisplay) closingDisplay.textContent = HeartMapState.data.letter.closing || 'With all my love...';
      if (signatureDisplay) signatureDisplay.textContent = HeartMapState.data.yourName || 'Your Valentine';
      
      // Update memory displays
      for (let i = 0; i < 3; i++) {
        if (HeartMapState.data.memories[i]) {
          const memory = HeartMapState.data.memories[i];
          
          // Update image if exists and not compressed
          if (memory.image && !memory.image.includes('[COMPRESSED]')) {
            const memoryDisplay = document.getElementById(`memory-${i+1}-display`);
            if (memoryDisplay) {
              memoryDisplay.innerHTML = `
                <img src="${memory.image}" 
                     class="w-full h-full object-cover rounded-xl"
                     alt="Memory ${i+1}">
              `;
            }
          }
          
          // Update caption
          if (memory.caption) {
            const textDisplay = document.getElementById(`memory-${i+1}-text-display`);
            if (textDisplay) {
              textDisplay.textContent = memory.caption;
            }
          }
        }
      }
      
      // Set up create your own button
      const createYourOwnBtn = document.getElementById('create-your-own-btn');
      if (createYourOwnBtn) {
        createYourOwnBtn.addEventListener('click', function() {
          // Reset state for response
          HeartMapState.reset();
          HeartMapState.data.partnerName = HeartMapState.data.yourName; // Set partner to original sender
          HeartMapState.save();
          
          // Remove view-only mode
          document.body.classList.remove('view-only');
          document.body.classList.add('creator-mode');
          
          // Navigate to greeting section
          navigateToSectionWithAnimation('greeting');
          
          // Show notification
          showNotification('üíå Creating a response Heart Map for your Valentine!');
        });
      }
    }
    
    // ========== SHARE FUNCTIONS ==========
    function initShareFunctions() {
      // WhatsApp share
      const whatsappBtn = document.getElementById('whatsapp-share');
      if (whatsappBtn) {
        whatsappBtn.addEventListener('click', () => {
          const shareId = HeartMapState.generateShareId();
          if (!shareId) {
            showNotification('‚ùå Could not generate share link. Please try again.');
            return;
          }
          
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?id=${shareId}`;
          
          // Check if mobile
          const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          const whatsappUrl = isMobile ? 
            `whatsapp://send?text=${encodeURIComponent(`üíñ Heart Map for you: ${shareUrl}`)}` :
            `https://web.whatsapp.com/send?text=${encodeURIComponent(`üíñ Heart Map for you: ${shareUrl}`)}`;
          
          window.open(whatsappUrl, '_blank');
          showNotification('üì± Opening WhatsApp to share your Heart Map!');
        });
      }
      
      // Copy link
      const copyLinkBtn = document.getElementById('copy-link');
      if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', async () => {
          const shareId = HeartMapState.generateShareId();
          if (!shareId) {
            showNotification('‚ùå Could not generate share link. Please try again.');
            return;
          }
          
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?id=${shareId}`;
          
          try {
            await navigator.clipboard.writeText(shareUrl);
            
            // Visual feedback
            const originalHTML = copyLinkBtn.innerHTML;
            const originalBg = copyLinkBtn.style.background;
            
            copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> Link Copied!';
            copyLinkBtn.style.background = 'linear-gradient(135deg, var(--sage), var(--deep-sage))';
            
            showNotification('‚úÖ Link copied to clipboard! Send this to your partner.');
            
            // Reset button after 2 seconds
            setTimeout(() => {
              copyLinkBtn.innerHTML = originalHTML;
              copyLinkBtn.style.background = originalBg;
            }, 2000);
            
          } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
              document.execCommand('copy');
              showNotification('‚úÖ Link copied to clipboard! Send this to your partner.');
            } catch (e) {
              showNotification('‚ùå Failed to copy link. Please try again.');
            }
            
            document.body.removeChild(textArea);
          }
        });
      }
      
      // Save draft
      const saveDraftBtn = document.getElementById('save-draft');
      if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', () => {
          HeartMapState.save();
          showNotification('üíæ Draft saved! You can continue anytime.');
        });
      }
    }
    
    function showNotification(message) {
      // Remove existing notifications
      document.querySelectorAll('.heartmap-notification').forEach(el => el.remove());
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'heartmap-notification';
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-rose-gold/10 flex items-center justify-center">
            <i class="fas fa-info-circle text-rose-gold"></i>
          </div>
          <div>
            <p class="font-medium">${message}</p>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 4 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(20px)';
        notification.style.transition = 'all 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }
    
    // ========== NAVIGATION ==========
    function initNavigation() {
      // Navigation dots
      document.querySelectorAll('.nav-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          const section = dot.dataset.section;
          navigateToSectionWithAnimation(section);
        });
      });
      
      // Section navigation buttons
      document.querySelectorAll('button[data-section]').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.section;
          navigateToSectionWithAnimation(section);
        });
      });
      
      // Start button
      const startBtn = document.getElementById('start-btn');
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          navigateToSectionWithAnimation('greeting');
        });
      }
      
      // Mark current section as active initially
      updateNavigationDots();
      showCurrentSection();
    }
    
    function showCurrentSection() {
      // Show only the current section
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.classList.remove('fade-in');
      });
      
      const currentSection = document.getElementById(HeartMapState.currentSection);
      if (currentSection) {
        currentSection.classList.add('active');
        
        // Add fade-in animation with a slight delay
        setTimeout(() => {
          currentSection.classList.add('fade-in');
        }, 50);
        
        window.scrollTo(0, 0);
      }
    }
    
    function updateNavigationDots() {
      document.querySelectorAll('.nav-dot').forEach(dot => {
        const section = dot.dataset.section;
        dot.classList.remove('active');
        
        if (section === HeartMapState.currentSection) {
          dot.classList.add('active');
        }
        
        if (HeartMapState.completedSections.has(section)) {
          dot.classList.add('completed');
        }
      });
    }
    
    // ========== PROGRESS INDICATOR ==========
    function updateProgress() {
      const totalSections = 6; // Now includes valentine-question
      const completed = HeartMapState.completedSections.size;
      const progress = (completed / totalSections) * 100;
      
      const progressFill = document.getElementById('progress-fill');
      if (progressFill) {
        progressFill.style.width = `${progress}%`;
      }
    }
    
    // ========== FORM BINDINGS ==========
    function initFormBindings() {
      // Partner name
      const partnerNameInput = document.getElementById('partner-name');
      if (partnerNameInput) {
        partnerNameInput.addEventListener('input', (e) => {
          HeartMapState.data.partnerName = e.target.value;
          HeartMapState.save();
          updatePreview();
        });
      }
      
      // Your name
      const yourNameInput = document.getElementById('your-name');
      if (yourNameInput) {
        yourNameInput.addEventListener('input', (e) => {
          HeartMapState.data.yourName = e.target.value;
          HeartMapState.save();
          updatePreview();
        });
      }
      
      // Letter sections
      ['opening', 'body', 'promise', 'closing'].forEach(section => {
        const element = document.getElementById(`letter-${section}`);
        if (element) {
          element.addEventListener('input', (e) => {
            HeartMapState.data.letter[section] = e.target.value;
            HeartMapState.save();
            updatePreview();
          });
        }
      });
      
      // Letter date
      const letterDateInput = document.getElementById('letter-date');
      if (letterDateInput) {
        letterDateInput.addEventListener('input', (e) => {
          HeartMapState.data.letter.date = e.target.value;
          HeartMapState.save();
        });
      }
    }
    
    // ========== MEMORY TEXT BINDINGS ==========
    function initMemoryTextBindings() {
      // Bind memory textareas to state
      for (let i = 1; i <= 3; i++) {
        const textarea = document.getElementById(`memory-${i}-text`);
        if (textarea) {
          // Load saved text
          if (HeartMapState.data.memories[i-1] && HeartMapState.data.memories[i-1].caption) {
            textarea.value = HeartMapState.data.memories[i-1].caption;
          }
          
          // Add input event listener
          textarea.addEventListener('input', (e) => {
            if (!HeartMapState.data.memories[i-1]) {
              HeartMapState.data.memories[i-1] = {};
            }
            HeartMapState.data.memories[i-1].caption = e.target.value;
            HeartMapState.save();
            updatePreview();
          });
        }
      }
    }
    
    function updateUIFromState() {
      // Partner name
      const partnerNameInput = document.getElementById('partner-name');
      const letterPartnerName = document.getElementById('letter-partner-name');
      const previewName = document.getElementById('preview-name');
      
      if (partnerNameInput) partnerNameInput.value = HeartMapState.data.partnerName;
      if (letterPartnerName) letterPartnerName.textContent = HeartMapState.data.partnerName || '[Name]';
      if (previewName) previewName.textContent = HeartMapState.data.partnerName || '[Name]';
      
      // Your name
      const yourNameInput = document.getElementById('your-name');
      const letterSignature = document.getElementById('letter-signature');
      
      if (yourNameInput) yourNameInput.value = HeartMapState.data.yourName;
      if (letterSignature) letterSignature.textContent = HeartMapState.data.yourName || '[Your Name]';
      
      // Letter sections
      Object.keys(HeartMapState.data.letter).forEach(section => {
        const element = document.getElementById(`letter-${section}`);
        if (element) element.value = HeartMapState.data.letter[section];
      });
      
      // Memory textareas
      for (let i = 1; i <= 3; i++) {
        const textarea = document.getElementById(`memory-${i}-text`);
        if (textarea && HeartMapState.data.memories[i-1] && HeartMapState.data.memories[i-1].caption) {
          textarea.value = HeartMapState.data.memories[i-1].caption;
        }
      }
      
      updatePreview();
    }
    
    // ========== MEDIA UPLOAD ==========
    function initMediaUpload() {
      const imageUpload = document.getElementById('image-upload');
      
      // Add click handlers to memory image containers
      ['memory-1', 'memory-2', 'memory-3'].forEach((id, index) => {
        const element = document.getElementById(id);
        if (element && HeartMapState.isCreator) {
          element.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling
            e.preventDefault();
            currentMemoryIndex = index;
            imageUpload.click();
          });
        }
      });
      
      imageUpload.addEventListener('change', handleImageUpload);
    }
    
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }
      
      // Check file size (limit to 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image is too large. Please select an image smaller than 2MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const memoryElement = document.getElementById(`memory-${currentMemoryIndex + 1}`);
        if (memoryElement) {
          memoryElement.innerHTML = `
            <img src="${event.target.result}" 
                 class="w-full h-full object-cover rounded-xl"
                 alt="Memory ${currentMemoryIndex + 1}">
            <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity duration-300 rounded-xl flex items-center justify-center">
              <div class="w-12 h-12 rounded-full bg-white/80 flex items-center justify-center">
                <i class="fas fa-edit text-rose-gold"></i>
              </div>
            </div>
          `;
          
          // Save to state
          if (!HeartMapState.data.memories[currentMemoryIndex]) {
            HeartMapState.data.memories[currentMemoryIndex] = {};
          }
          HeartMapState.data.memories[currentMemoryIndex].image = event.target.result;
          HeartMapState.save();
          updatePreview();
          
          // Success animation
          memoryElement.style.animation = 'gentlePulse 1s';
          setTimeout(() => memoryElement.style.animation = '', 1000);
          
          showNotification('‚úÖ Photo added successfully!');
        }
      };
      reader.readAsDataURL(file);
      
      // Reset input
      e.target.value = '';
    }
    
    // ========== MUSIC PLAYER ==========
    function initMusicPlayer() {
      const audio = document.getElementById('audio-player');
      const playBtn = document.getElementById('play-btn');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');
      const uploadBtn = document.getElementById('upload-song-btn');
      const audioUpload = document.getElementById('audio-upload');
      const songTitle = document.getElementById('song-title');
      
      if (!audio || !playBtn || !songTitle) return;
      
      let isPlaying = false;
      let currentSong = HeartMapState.data.song;
      
      // Load saved song
      if (currentSong && currentSong.url) {
        audio.src = currentSong.url;
        songTitle.textContent = currentSong.name;
      }
      
      playBtn.addEventListener('click', () => {
        if (!audio.src) {
          alert('Please upload a song first');
          if (HeartMapState.isCreator && uploadBtn) {
            uploadBtn.click();
          }
          return;
        }
        
        if (isPlaying) {
          audio.pause();
        } else {
          audio.play().catch(e => {
            console.error('Playback error:', e);
            alert('Unable to play the audio file. Please try another.');
          });
        }
        
        isPlaying = !isPlaying;
        if (playIcon) playIcon.classList.toggle('hidden', isPlaying);
        if (pauseIcon) pauseIcon.classList.toggle('hidden', !isPlaying);
      });
      
      if (HeartMapState.isCreator && uploadBtn) {
        uploadBtn.addEventListener('click', () => {
          audioUpload.click();
        });
        
        audioUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (!file.type.startsWith('audio/')) {
            alert('Please select an audio file');
            return;
          }
          
          const url = URL.createObjectURL(file);
          currentSong = {
            name: file.name.replace(/\.[^/.]+$/, ""),
            url: url
          };
          
          audio.src = url;
          songTitle.textContent = currentSong.name;
          
          // Save to state
          HeartMapState.data.song = currentSong;
          HeartMapState.save();
          
          // Auto-play
          setTimeout(() => {
            audio.play();
            isPlaying = true;
            if (playIcon) playIcon.classList.add('hidden');
            if (pauseIcon) pauseIcon.classList.remove('hidden');
          }, 300);
        });
      }
      
      audio.addEventListener('ended', () => {
        isPlaying = false;
        if (playIcon) playIcon.classList.remove('hidden');
        if (pauseIcon) pauseIcon.classList.add('hidden');
      });
    }
    
    // ========== PREVIEW UPDATES ==========
    function initPreviewUpdates() {
      updatePreview();
    }
    
    function updatePreview() {
      // Update letter word count
      const letterText = Object.values(HeartMapState.data.letter).join(' ');
      const wordCount = letterText.trim() ? letterText.trim().split(/\s+/).length : 0;
      const previewLetterLength = document.getElementById('preview-letter-length');
      if (previewLetterLength) previewLetterLength.textContent = wordCount;
      
      // Update photo count
      const photoCount = HeartMapState.data.memories.filter(m => m && m.image).length;
      const previewPhotoCount = document.getElementById('preview-photo-count');
      if (previewPhotoCount) previewPhotoCount.textContent = photoCount;
    }
  </script>
</body>
</html>
